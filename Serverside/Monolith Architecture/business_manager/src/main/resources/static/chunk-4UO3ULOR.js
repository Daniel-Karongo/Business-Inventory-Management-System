import{a as qt}from"./chunk-J24UQWHM.js";import{a as Nt}from"./chunk-AFQQC2YZ.js";import{a as Pt}from"./chunk-TM2CIIHB.js";import{a as dt}from"./chunk-L3RCXL5W.js";import{a as kt}from"./chunk-ZGWKAQJ5.js";import{a as Et}from"./chunk-DRL2JGJN.js";import{a as Ft}from"./chunk-6ZHWXBBQ.js";import"./chunk-AM43YPRF.js";import"./chunk-VQD42P6V.js";import"./chunk-PUDW2OXT.js";import{k as wt}from"./chunk-IFBDMVRJ.js";import"./chunk-VGEQVDR7.js";import{a as lt,b as st}from"./chunk-JNUXAAQA.js";import{c as ht}from"./chunk-727AWRP5.js";import{a as vt}from"./chunk-HHYKBKON.js";import"./chunk-MS4AQ6UA.js";import{a as Vt,b as Mt}from"./chunk-NUV7N7IM.js";import{d as W}from"./chunk-PJQ2W5C7.js";import"./chunk-2CD73GIG.js";import{b as at,c as ct}from"./chunk-NP55MDY3.js";import"./chunk-NKX2CJ22.js";import{c as yt,d as xt}from"./chunk-IMZ4R6CL.js";import{b as bt,c as gt,d as It,e as St,h as _t,i as Ct}from"./chunk-EWJIHEWL.js";import"./chunk-SGYCFQGT.js";import{d as z,f as _,h as J,i as X,k as Y,n as Z,o as tt,p as et,s as it,t as rt,v as nt,x as ot}from"./chunk-J63CKRDU.js";import"./chunk-CN565FBG.js";import{f as ut,g as pt,h as ft}from"./chunk-A6LP6NU3.js";import"./chunk-7XXZ3FER.js";import{b as K,d as $}from"./chunk-PBEYJMJD.js";import"./chunk-LMLMO6HS.js";import{a as mt}from"./chunk-5DTMLZHP.js";import{$c as U,A as F,C as k,E as N,H as q,Ib as o,Jb as n,Kb as g,Ob as y,Qb as h,Rb as I,Rc as L,S as T,Sc as G,Wb as O,Xb as D,Yb as R,Zc as H,ab as B,ac as c,bb as s,cc as C,gb as p,hd as Q,kc as j,m as E,ma as v,na as b,nb as A,nc as M,pc as P,sb as S,zb as u}from"./chunk-IL4QWM46.js";import{a as w,h as V}from"./chunk-FJYW2LMB.js";var Bt=["barcodeInput"],At=()=>[];function Ot(m,t){if(m&1){let e=y();o(0,"button",25),h("click",function(){v(e);let r=I();return b(r.startCameraScan())}),o(1,"mat-icon"),c(2,"qr_code_scanner"),n()()}}function Dt(m,t){if(m&1&&(o(0,"mat-option",39),c(1),n()),m&2){let e=t.$implicit;u("value",e.id),s(),C(" ",e.classification||"STANDARD"," ")}}function Rt(m,t){m&1&&(o(0,"mat-hint"),c(1," Select a product to load variants "),n())}function jt(m,t){if(m&1&&(o(0,"mat-option",39),c(1),n()),m&2){let e=t.$implicit;u("value",e.id),s(),C(" ",e.name," ")}}function Lt(m,t){if(m&1&&(o(0,"mat-error"),c(1),n()),m&2){let e=I().index,i=I();s(),C(" Exceeds available stock (",i.stockMap[e],") ")}}function Gt(m,t){if(m&1){let e=y();o(0,"div",26)(1,"div",27)(2,"mat-form-field",28),h("click",function(){let r=v(e).index,a=I();return b(a.openProductSelector(r))}),o(3,"mat-label"),c(4,"Product"),n(),g(5,"input",29),o(6,"button",30)(7,"mat-icon"),c(8,"edit"),n()()()(),o(9,"mat-form-field")(10,"mat-select",31),h("selectionChange",function(r){let a=v(e).index,d=I();return b(d.onVariantChange(a,r.value))}),S(11,Dt,2,2,"mat-option",32),n(),S(12,Rt,2,0,"mat-hint",33),n(),o(13,"mat-form-field")(14,"mat-select",34),S(15,jt,2,2,"mat-option",32),n()(),o(16,"mat-form-field"),g(17,"input",35),S(18,Lt,2,1,"mat-error",33),n(),o(19,"mat-form-field"),g(20,"input",36),n(),o(21,"div",37),c(22),M(23,"currency"),n(),o(24,"button",38),h("click",function(){let r=v(e).index,a=I();return b(a.removeLine(r))}),o(25,"mat-icon"),c(26,"delete"),n()()()}if(m&2){let e=t.index,i=I();s(5),u("value",i.items.at(e).value.productName||""),s(5),u("formControl",i.controlAt(e,"productVariantId"))("disabled",!(i.variantsMap[e]!=null&&i.variantsMap[e].length)),s(),u("ngForOf",i.variantsMap[e]||j(14,At)),s(),u("ngIf",!(i.variantsMap[e]!=null&&i.variantsMap[e].length)),s(2),u("formControl",i.controlAt(e,"branchId")),s(),u("ngForOf",i.branches),s(2),u("formControl",i.controlAt(e,"quantity")),s(),u("ngIf",i.controlAt(e,"quantity").hasError("stockExceeded")),s(2),u("formControl",i.controlAt(e,"unitPrice")),s(2),C(" ",P(23,11,i.lineTotal(e),"KES ")," ")}}var Tt=class m{constructor(t,e,i,r,a,d,f,l,x,Ht,Ut,Qt){this.fb=t;this.productService=e;this.variantService=i;this.inventoryService=r;this.branchService=a;this.salesService=d;this.customerService=f;this.route=l;this.router=x;this.authService=Ht;this.http=Ut;this.dialog=Qt}barcodeInput;scanning=!1;barcodeValue="";barcodeCtrl=new Y("");form;products=[];variants=[];branches=[];displayedColumns=["product","branch","qty","price","total","remove"];variantsMap={};stockMap={};defaultBranchId=null;ngOnInit(){this.form=this.fb.group({customer:this.fb.group({name:this.fb.control(null),phone:this.fb.control(null),email:this.fb.control(null)}),items:this.fb.array([],_.required)});let t=history.state?.inventorySeed;t?.productId&&(t.variantId?this.prefillFromInventory(t):this.prefillProductOnly(t));let e=this.authService.getSnapshot();this.defaultBranchId=e?.branchId??null,this.form.controls.customer.controls.phone.valueChanges.pipe(N(500),q(),F(i=>!!i&&i.length>=9),T(i=>this.customerService.lookupByPhone(i).pipe(k(()=>E(null))))).subscribe(i=>{if(!i){this.unlockCustomerFields();return}this.form.controls.customer.patchValue({name:i.name,email:i.emailAddresses?.[0]??null}),this.lockCustomerFields()}),this.productService.getAll().subscribe(i=>this.products=i),this.branchService.getAll(!1).subscribe(i=>this.branches=i),this.addLine(),this.variantsMap[0]=[]}prefillFromInventory(t){let e=this.createSaleItemForm({productId:t.productId,productName:t.productName,productVariantId:t.variantId,branchId:t.branchId,quantity:1});this.items.clear(),this.items.push(e);let i=0;this.variantService.forProduct(t.productId).subscribe(r=>{this.variantsMap[i]=r;let a=r.find(d=>d.id===t.variantId);a&&e.patchValue({unitPrice:a.minimumSellingPrice})}),this.loadStock(i,t.variantId,t.branchId)}prefillProductOnly(t){let e=this.createSaleItemForm({productId:t.productId,productName:t.productName,quantity:1});this.items.clear(),this.items.push(e);let i=0;this.variantService.forProduct(t.productId).subscribe(r=>{this.variantsMap[i]=r,r.length===1&&e.patchValue({productVariantId:r[0].id,unitPrice:r[0].minimumSellingPrice})})}createSaleItemForm(t){return this.fb.group({productId:this.fb.control(t?.productId??null,_.required),productName:this.fb.control(t?.productName??null),productVariantId:this.fb.control(t?.productVariantId??null,_.required),branchId:this.fb.control(t?.branchId??this.defaultBranchId,_.required),quantity:this.fb.control(t?.quantity??1,{nonNullable:!0,validators:[_.required,_.min(1)]}),unitPrice:this.fb.control(t?.unitPrice??null)})}get customerGroup(){return this.form.controls.customer}get items(){return this.form.controls.items}lockCustomerFields(){this.form.controls.customer.controls.name.disable(),this.form.controls.customer.controls.email.disable()}unlockCustomerFields(){this.form.controls.customer.controls.name.enable(),this.form.controls.customer.controls.email.enable()}addLine(){this.items.push(this.createSaleItemForm());let t=this.items.length-1;this.variantsMap[t]=[]}removeLine(t){this.items.removeAt(t),delete this.variantsMap[t],delete this.stockMap[t],this.variantsMap=Object.values(this.variantsMap).reduce((e,i,r)=>(e[r]=i,e),{}),this.stockMap=Object.values(this.stockMap).reduce((e,i,r)=>(e[r]=i,e),{})}scanBarcode(t){let e=(t??this.barcodeCtrl.value)?.trim();if(!e)return;let i={barcode:e,branchId:this.defaultBranchId};this.http.post(`${mt.apiUrl}/product-variants/scan`,i).subscribe({next:r=>this.applyScannedVariant(r),error:()=>alert("Invalid barcode / SKU")}),this.barcodeCtrl.setValue("")}applyScannedVariant(t){let e=t.branchId??this.defaultBranchId,i=this.items.controls.findIndex(l=>l.value.productVariantId===t.variantId&&l.value.branchId===e);if(i!==-1){let l=this.items.at(i).get("quantity");l.setValue(l.value+1);return}let r=this.items.controls.findIndex(l=>l.value.productId===t.productId&&!l.value.productVariantId);if(r!==-1){let l=this.items.at(r);l.patchValue({productVariantId:t.variantId,unitPrice:t.sellingPrice}),this.ensureVariantsLoaded(r,t.productId,t.variantId);let x=l.get("quantity");x.setValue(x.value+1);return}let a=this.items.controls.findIndex(l=>!l.value.productId);if(a!==-1){this.items.at(a).patchValue({productId:t.productId,productName:t.productName,productVariantId:t.variantId,branchId:e,quantity:1,unitPrice:t.sellingPrice}),this.ensureVariantsLoaded(a,t.productId,t.variantId),e&&(this.stockMap[a]=t.quantityOnHand??0);return}let d=this.createSaleItemForm({productId:t.productId,productName:t.productName,productVariantId:t.variantId,branchId:e,quantity:1,unitPrice:t.sellingPrice});this.items.push(d);let f=this.items.length-1;this.ensureVariantsLoaded(f,t.productId,t.variantId),e&&(this.stockMap[f]=t.quantityOnHand??0)}clearVariantSelection(t){this.items.at(t).patchValue({productVariantId:null,unitPrice:null}),delete this.stockMap[t]}clearProductVariants(t){this.variantsMap[t]=[]}resetProductDependentState(t){this.items.at(t).patchValue({productVariantId:null,unitPrice:null}),delete this.stockMap[t],this.variantsMap[t]=[]}canUseCameraScan(){return"BarcodeDetector"in window&&navigator.mediaDevices&&typeof navigator.mediaDevices.getUserMedia=="function"}startCameraScan(){return V(this,null,function*(){if(!("BarcodeDetector"in window)){alert("Camera scanning not supported on this device");return}let t=new window.BarcodeDetector({formats:["code_128","ean_13","ean_8"]}),e=yield navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}}),i=document.createElement("video");i.srcObject=e,i.play(),this.scanning=!0;let r=()=>V(this,null,function*(){if(!this.scanning)return;let a=yield t.detect(i);if(a.length){this.scanning=!1,e.getTracks().forEach(d=>d.stop()),this.scanBarcode(a[0].rawValue);return}requestAnimationFrame(r)});r()})}openProductSelector(t){this.dialog.open(kt,{width:"90vw",maxWidth:"1000px",height:"85vh",panelClass:"responsive-dialog"}).afterClosed().subscribe(e=>{e?.length&&e.forEach(i=>{let r=this.items.controls.findIndex(d=>d.value.productId===i.id);if(r!==-1){let d=this.items.at(r).get("quantity");d.setValue(d.value+1);return}let a=this.items.at(t).value.productId?this.items.controls.findIndex(d=>!d.value.productId):t;if(a!==-1){this.patchProductIntoRow(a,i);return}this.addProductAsNewLine(i)})})}patchProductIntoRow(t,e){let i=this.items.at(t);i.patchValue({productId:e.id,productName:e.name}),this.clearVariantSelection(t),this.clearProductVariants(t),this.variantService.forProduct(e.id).subscribe(r=>{this.variantsMap[t]=r,r.length===1&&i.patchValue({productVariantId:r[0].id,unitPrice:r[0].minimumSellingPrice})})}addProductAsNewLine(t){let e=this.createSaleItemForm({productId:t.id,productName:t.name});this.items.push(e);let i=this.items.length-1;this.variantService.forProduct(t.id).subscribe(r=>{this.variantsMap[i]=r,r.length===1&&e.patchValue({productVariantId:r[0].id,unitPrice:r[0].minimumSellingPrice})})}ensureVariantsLoaded(t,e,i){this.variantsMap[t]?.length||this.variantService.forProduct(e).subscribe(r=>{this.variantsMap[t]=r,i&&r.some(a=>a.id===i)&&this.items.at(t).patchValue({productVariantId:i}),r.length===1&&this.items.at(t).patchValue({productVariantId:r[0].id,unitPrice:r[0].minimumSellingPrice})})}onProductChange(t){let e=this.items.at(t);if(!e)return;let i=e.get("productId")?.value;i&&(e.patchValue({productVariantId:null,unitPrice:null}),delete this.stockMap[t],this.variantsMap[t]=[],this.variantService.forProduct(i).subscribe(r=>{this.variantsMap[t]=r,r.length===1&&(e.get("productVariantId")?.setValue(r[0].id),this.onVariantChange(t,r[0].id))}))}onVariantChange(t,e){let i=this.items.at(t);if(!i)return;let r=this.variantsMap[t]?.find(d=>d.id===e);if(!r)return;i.get("unitPrice")?.setValue(r.minimumSellingPrice);let a=i.get("branchId")?.value;a&&this.loadStock(t,r.id,a)}loadStock(t,e,i){this.inventoryService.getVariantStock(e,i).subscribe(r=>{if(!r)return;let a=r.quantityOnHand-r.quantityReserved;this.stockMap[t]=a;let f=this.items.at(t).get("quantity");if(f){if(f.value>a)f.setErrors({stockExceeded:!0});else if(f.hasError("stockExceeded")){let l=w({},f.errors);delete l.stockExceeded,f.setErrors(Object.keys(l).length?l:null)}}})}lineTotal(t){let e=this.items.at(t).value,i=Number(e.quantity||0),r=Number(e.unitPrice||0);return i*r}grandTotal(){return this.items.controls.map((t,e)=>this.lineTotal(e)).reduce((t,e)=>t+e,0)}controlAt(t,e){return this.items.at(t).get(e)}submitShortcut(){this.form.valid&&this.submit()}submit(){if(this.form.invalid)return;let t=this.form.controls.customer.value,i={items:this.items.controls.map(r=>r.value).map(r=>({productVariantId:r.productVariantId,branchId:r.branchId,quantity:r.quantity,unitPrice:r.unitPrice}))};(t.name||t.phone||t.email)&&(i.customerIdentifiers={name:t.name??null,phone:t.phone??null,email:t.email??null}),this.salesService.create(i).subscribe({next:r=>this.router.navigate(["/sales",r.id])})}static \u0275fac=function(e){return new(e||m)(p(nt),p(Ft),p(Nt),p(Et),p(vt),p(Pt),p(qt),p(K),p($),p(dt),p(Q),p(ht))};static \u0275cmp=A({type:m,selectors:[["app-sale-create"]],viewQuery:function(e,i){if(e&1&&O(Bt,5),e&2){let r;D(r=R())&&(i.barcodeInput=r.first)}},hostBindings:function(e,i){e&1&&h("keydown.control.enter",function(){return i.submitShortcut()},!1,B)},decls:59,vars:8,consts:[["barcodeInput",""],[1,"flex","flex-col","gap-4"],[1,"text-xl","font-semibold"],[1,"text-sm","text-[var(--text-secondary)]"],[1,"bg-[var(--surface)]","p-4","rounded","shadow-sm","mb-4",3,"formGroup"],[1,"mb-2"],[1,"text-sm","font-medium"],[1,"text-xs","text-[var(--text-secondary)]"],[1,"grid","grid-cols-1","md:grid-cols-3","gap-4"],["appearance","fill"],["matInput","","formControlName","name"],["matInput","","placeholder","2547...","formControlName","phone"],["matInput","","formControlName","email"],[1,"flex","items-center","gap-2","mb-4"],[1,"flex-1"],["matInput","","placeholder","Scan or type barcode",3,"keydown.enter","formControl"],["mat-stroked-button","","matTooltip","Scan using camera",3,"click",4,"ngIf"],[1,"bg-[var(--surface)]","p-4","rounded","shadow"],[1,"grid","grid-cols-[2.2fr_1.2fr_1.6fr_0.7fr_1.2fr_1fr_40px]","gap-4","mb-2","text-sm","font-medium","text-[var(--text-secondary)]"],["class","grid grid-cols-[2.2fr_1.2fr_1.6fr_0.7fr_1.2fr_1fr_40px] gap-4 items-center mb-3",4,"ngFor","ngForOf"],[1,"flex","justify-between","items-center","mt-6"],["mat-stroked-button","",3,"click"],[1,"text-lg","font-semibold"],[1,"flex","justify-end","mt-6"],["mat-flat-button","",3,"click"],["mat-stroked-button","","matTooltip","Scan using camera",3,"click"],[1,"grid","grid-cols-[2.2fr_1.2fr_1.6fr_0.7fr_1.2fr_1fr_40px]","gap-4","items-center","mb-3"],[1,"flex","flex-col","gap-1"],["appearance","fill",1,"cursor-pointer",3,"click"],["matInput","","readonly","",3,"value"],["matSuffix","","mat-icon-button","","tabindex","-1"],["placeholder","Variant",3,"selectionChange","formControl","disabled"],[3,"value",4,"ngFor","ngForOf"],[4,"ngIf"],["enterNext","","placeholder","Branch",3,"formControl"],["matInput","","enterNext","","type","number","min","1",3,"formControl"],["matInput","","enterNext","","type","number","min","0",3,"formControl"],[1,"font-medium","text-right","pr-2"],["mat-icon-button","","matTooltip","Remove line",3,"click"],[3,"value"]],template:function(e,i){if(e&1){let r=y();o(0,"div",1)(1,"div")(2,"h2",2),c(3,"New Sale"),n(),o(4,"p",3),c(5," Add items and confirm "),n()(),o(6,"div",4)(7,"div",5)(8,"div",6),c(9,"Customer (Optional)"),n(),o(10,"div",7),c(11," Leave blank for walk-in customers "),n()(),o(12,"div",8)(13,"mat-form-field",9)(14,"mat-label"),c(15,"Name"),n(),g(16,"input",10),n(),o(17,"mat-form-field",9)(18,"mat-label"),c(19,"Phone"),n(),g(20,"input",11),n(),o(21,"mat-form-field",9)(22,"mat-label"),c(23,"Email"),n(),g(24,"input",12),n()()(),o(25,"div",13)(26,"mat-form-field",14)(27,"mat-label"),c(28,"Scan / Enter Barcode or SKU"),n(),o(29,"input",15,0),h("keydown.enter",function(){return v(r),b(i.scanBarcode())}),n()(),S(31,Ot,3,0,"button",16),n(),o(32,"div",17)(33,"div",18)(34,"div"),c(35,"Product"),n(),o(36,"div"),c(37,"Variant"),n(),o(38,"div"),c(39,"Branch"),n(),o(40,"div"),c(41,"Qty"),n(),o(42,"div"),c(43,"Unit Price"),n(),o(44,"div"),c(45,"Total"),n(),g(46,"div"),n(),S(47,Gt,27,15,"div",19),o(48,"div",20)(49,"button",21),h("click",function(){return v(r),b(i.addLine())}),o(50,"mat-icon"),c(51,"add"),n(),c(52," Add Line "),n(),o(53,"div",22),c(54),M(55,"currency"),n()(),o(56,"div",23)(57,"button",24),h("click",function(){return v(r),b(i.submit())}),c(58," Create Sale "),n()()()()}e&2&&(s(6),u("formGroup",i.customerGroup),s(23),u("formControl",i.barcodeCtrl),s(2),u("ngIf",i.canUseCameraScan()),s(16),u("ngForOf",i.items.controls),s(7),C(" Total: ",P(55,5,i.grandTotal(),"KES ")," "))},dependencies:[U,L,G,H,ot,z,Z,J,X,rt,tt,et,it,Ct,_t,bt,It,gt,St,xt,yt,Mt,Vt,W,ft,pt,ut,ct,at,wt,st,lt],styles:["mat-form-field[_ngcontent-%COMP%]{width:100%}.mat-mdc-form-field-infix[_ngcontent-%COMP%]{min-width:0}input[_ngcontent-%COMP%], mat-select[_ngcontent-%COMP%]{white-space:nowrap}.cursor-pointer[_ngcontent-%COMP%]{cursor:pointer}mat-form-field[_ngcontent-%COMP%]:hover   input[readonly][_ngcontent-%COMP%]{background-color:#00000008}"]})};export{Tt as SaleCreateComponent};
