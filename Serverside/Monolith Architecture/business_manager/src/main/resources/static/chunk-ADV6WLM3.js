import{a as Y,b as Z,c as B,e as J,f as K,g as Q,h as X}from"./chunk-G6DPSII6.js";import{b as q}from"./chunk-GQKP7E5B.js";import{c as ie,d as oe}from"./chunk-ZFWGKVXC.js";import"./chunk-3RK6DDJD.js";import{a as ne}from"./chunk-CONPK5ZF.js";import{b as ee,h as te}from"./chunk-3ZV2DC5Q.js";import"./chunk-SGYCFQGT.js";import{d as L,h as W,l as U,w as H}from"./chunk-Z2GGFO6C.js";import"./chunk-75T6YVBZ.js";import"./chunk-2X53NFZU.js";import{a as G}from"./chunk-5DTMLZHP.js";import{Bb as h,Ib as a,Jb as o,Lb as I,Mb as S,Ob as y,Qb as g,Rb as c,Tc as P,Uc as N,Z as M,ac as s,bb as l,bc as C,bd as O,ca as D,cc as x,da as b,gb as u,gc as $,hc as j,ic as z,jd as A,ma as _,na as f,nb as w,sb as p,w as F,yb as V,zb as d}from"./chunk-3DYKM6ZU.js";import"./chunk-FJYW2LMB.js";var R=class i{http=b(A);base=`${G.apiUrl}/admin/acl`;roles(){return this.http.get(`${this.base}/roles`)}permissions(){return this.http.get(`${this.base}/permissions`)}rolePermissions(){return this.http.get(`${this.base}/role-permissions`)}static \u0275fac=function(e){return new(e||i)};static \u0275prov=M({token:i,factory:i.\u0275fac,providedIn:"root"})};function ce(i,t){if(i&1&&(a(0,"li")(1,"span",10),s(2),o(),a(3,"span",11),s(4,"\u2192"),o(),a(5,"span",12),s(6),o(),a(7,"span",13),s(8),o()()),i&2){let e=t.$implicit;h("allow",e.newValue)("deny",!e.newValue),l(2),C(e.role),l(4),C(e.permission),l(2),x(" ",e.newValue?"ALLOW":"DENY"," ")}}var E=class i{constructor(t,e){this.data=t;this.ref=e}reason="";confirm(){this.reason.trim()&&this.ref.close(this.reason)}cancel(){this.ref.close(null)}static \u0275fac=function(e){return new(e||i)(u(Z),u(Y))};static \u0275cmp=w({type:i,selectors:[["ng-component"]],decls:17,vars:3,consts:[["mat-dialog-title","",1,"dialog-title"],["mat-dialog-content","",1,"dialog-body"],[1,"dialog-subtitle"],[1,"diff-list"],[3,"allow","deny",4,"ngFor","ngForOf"],["appearance","fill",1,"reason-field"],["matInput","","rows","3","placeholder","Explain why these permission changes are required",3,"ngModelChange","ngModel"],["mat-dialog-actions","","align","end"],["mat-stroked-button","",3,"click"],["mat-flat-button","","color","primary",3,"click","disabled"],[1,"role"],[1,"arrow"],[1,"perm"],[1,"result"]],template:function(e,n){e&1&&(a(0,"h2",0),s(1,` Confirm Access Control Changes
`),o(),a(2,"div",1)(3,"p",2),s(4," Review the permission changes below before applying them. "),o(),a(5,"ul",3),p(6,ce,9,7,"li",4),o(),a(7,"mat-form-field",5)(8,"mat-label"),s(9,"Reason"),o(),a(10,"textarea",6),z("ngModelChange",function(m){return j(n.reason,m)||(n.reason=m),m}),s(11,"    "),o()()(),a(12,"div",7)(13,"button",8),g("click",function(){return n.cancel()}),s(14,"Cancel"),o(),a(15,"button",9),g("click",function(){return n.confirm()}),s(16," Apply Changes "),o()()),e&2&&(l(6),d("ngForOf",n.data.changes),l(4),$("ngModel",n.reason),l(5),d("disabled",!n.reason))},dependencies:[O,P,H,L,W,U,X,J,Q,K,ne,te,ee,oe,ie],styles:[".dialog-title[_ngcontent-%COMP%]{font-size:18px;font-weight:600;margin-bottom:8px}.dialog-subtitle[_ngcontent-%COMP%]{font-size:var(--text-sm);color:var(--text-secondary);margin-bottom:12px}.diff-list[_ngcontent-%COMP%]{list-style:none;padding:0;margin:0 0 12px}.diff-list[_ngcontent-%COMP%]   li[_ngcontent-%COMP%]{display:flex;gap:6px;padding:6px 8px;border-radius:6px;font-size:13px}.diff-list[_ngcontent-%COMP%]   li.allow[_ngcontent-%COMP%]{background:#22c55e1f;color:#166534}.diff-list[_ngcontent-%COMP%]   li.deny[_ngcontent-%COMP%]{background:#ef44441f;color:#7f1d1d}.role[_ngcontent-%COMP%]{font-weight:600}.perm[_ngcontent-%COMP%]{font-family:monospace}.result[_ngcontent-%COMP%]{margin-left:auto;font-weight:700}.required[_ngcontent-%COMP%]{color:#ef4444}.dialog-body[_ngcontent-%COMP%]{padding-top:8px}.reason-field[_ngcontent-%COMP%]{width:100%;margin-top:12px}"]})};var k=class i{constructor(t){this.http=t}apply(t,e){return this.http.post("/api/admin/acl/role-permissions/bulk",{changes:t,reason:e})}static \u0275fac=function(e){return new(e||i)(D(A))};static \u0275prov=M({token:i,factory:i.\u0275fac,providedIn:"root"})};function pe(i,t){if(i&1){let e=y();a(0,"button",15),g("click",function(){_(e);let r=c();return f(r.toggleEdit())}),s(1," Enable Editing "),o()}}function me(i,t){if(i&1){let e=y();I(0),a(1,"button",16),g("click",function(){_(e);let r=c();return f(r.cancelEdit())}),s(2," Cancel "),o(),a(3,"button",17),g("click",function(){_(e);let r=c();return f(r.reviewChanges())}),s(4," Review & Apply "),o(),S()}if(i&2){let e=c();l(3),d("disabled",!e.pendingChanges.length)}}function ge(i,t){if(i&1&&(a(0,"span",20),s(1),o()),i&2){let e=c(2);l(),x(" ",e.pendingChanges.length," pending ")}}function _e(i,t){if(i&1&&(a(0,"div",18)(1,"span"),s(2,"Editing enabled \u2014 changes are not saved yet"),o(),p(3,ge,2,1,"span",19),o()),i&2){let e=c();l(3),d("ngIf",e.pendingChanges.length)}}function fe(i,t){i&1&&(a(0,"div",21),s(1," Loading role / permission matrix\u2026 "),o())}function xe(i,t){if(i&1&&(a(0,"th",22),s(1),o()),i&2){let e=t.$implicit;l(),x(" ",e.name," ")}}function ue(i,t){i&1&&(a(0,"span",32),s(1,"+"),o())}function he(i,t){i&1&&(a(0,"span",33),s(1,"\u2212"),o())}function Ce(i,t){if(i&1&&(a(0,"span"),s(1),o()),i&2){let e=c().$implicit,n=c().$implicit,r=c(2);h("granted",r.has(e.name,n.code))("denied",!r.has(e.name,n.code)),l(),x(" ",r.has(e.name,n.code)?"\u2714":"\u2014"," ")}}function ve(i,t){if(i&1){let e=y();a(0,"td",28),g("click",function(){let r=_(e).$implicit,m=c().$implicit,v=c(2);return f(v.toggle(r.name,m.code))})("keydown.enter",function(){let r=_(e).$implicit,m=c().$implicit,v=c(2);return f(v.toggle(r.name,m.code))})("keydown.space",function(){let r=_(e).$implicit,m=c().$implicit,v=c(2);return f(v.toggle(r.name,m.code))}),p(1,ue,2,0,"span",29)(2,he,2,0,"span",30)(3,Ce,2,5,"span",31),o()}if(i&2){let e=t.$implicit,n=c().$implicit,r=c(2);h("pending-add",r.isPendingAdd(e.name,n.code))("pending-remove",r.isPendingRemove(e.name,n.code)),l(),d("ngIf",r.isPendingAdd(e.name,n.code)),l(),d("ngIf",r.isPendingRemove(e.name,n.code)),l(),d("ngIf",!r.isPending(e.name,n.code))}}function Me(i,t){if(i&1&&(a(0,"tr")(1,"td",24)(2,"div",25),s(3),o(),a(4,"div",26),s(5),o()(),p(6,ve,4,7,"td",27),o()),i&2){let e=t.$implicit,n=c(2);l(3),C(n.humanize(e.code)),l(2),C(e.code),l(),d("ngForOf",n.orderedRoles())}}function be(i,t){if(i&1&&(I(0),a(1,"tr",23)(2,"td",24),s(3),o()(),p(4,Me,7,3,"tr",14),S()),i&2){let e=t.$implicit,n=c();l(2),V("colspan",n.orderedRoles().length+1),l(),x(" ",e[0]," "),l(),d("ngForOf",e[1])}}var re=class i{constructor(t,e){this.dialog=t;this.aclAdmin=e}svc=b(R);roles=[];permissions=[];grants=new Set;editMode=!1;loadingMatrix=!0;pendingChanges=[];ROLE_ORDER=["SUPERUSER","ADMIN","MANAGER","SUPERVISOR","EMPLOYEE"];ngOnInit(){this.load()}load(){this.loadingMatrix=!0,F({roles:this.svc.roles(),perms:this.svc.permissions(),grants:this.svc.rolePermissions()}).subscribe(({roles:t,perms:e,grants:n})=>{this.roles=t,this.permissions=e,this.grants.clear(),n.filter(r=>r.active&&r.allowed).forEach(r=>this.grants.add(`${r.role.name}:${r.permission.code}`)),this.loadingMatrix=!1})}orderedRoles(){return[...this.roles].sort((t,e)=>this.ROLE_ORDER.indexOf(t.name)-this.ROLE_ORDER.indexOf(e.name))}groupedPermissions(){let t={};for(let e of this.permissions){let n=this.extractModule(e.code);t[n]??=[],t[n].push(e)}return Object.entries(t).sort(([e],[n])=>e.localeCompare(n))}has(t,e){return this.grants.has(`${t}:${e}`)}toggleEdit(){this.editMode=!0}cancelEdit(){this.editMode=!1,this.pendingChanges=[]}toggle(t,e){if(!this.editMode)return;let n=this.has(t,e);this.pendingChanges=this.pendingChanges.filter(r=>!(r.role===t&&r.permission===e)),this.pendingChanges.push({role:t,permission:e,newValue:!n})}isPending(t,e){return this.pendingChanges.some(n=>n.role===t&&n.permission===e)}isPendingAdd(t,e){return this.pendingChanges.some(n=>n.role===t&&n.permission===e&&n.newValue)}isPendingRemove(t,e){return this.pendingChanges.some(n=>n.role===t&&n.permission===e&&!n.newValue)}pendingTooltip(t,e){return this.isPendingAdd(t,e)?"Will be granted":this.isPendingRemove(t,e)?"Will be revoked":""}reviewChanges(){this.dialog.open(E,{minWidth:"520px",maxWidth:"80vw",data:{changes:this.pendingChanges}}).afterClosed().subscribe(e=>{e&&this.aclAdmin.apply(this.pendingChanges,e).subscribe(()=>{this.editMode=!1,this.pendingChanges=[],this.load()})})}extractModule(t){let e=t.match(/API_[A-Z]+_API_([^_]+)/);return e?e[1]:"OTHER"}humanize(t){return t.replace(/^API_[A-Z]+_API_/,"").replace(/_/g," ").toLowerCase().replace(/\b\w/g,e=>e.toUpperCase())}static \u0275fac=function(e){return new(e||i)(u(B),u(k))};static \u0275cmp=w({type:i,selectors:[["app-acl-role-matrix"]],decls:22,vars:8,consts:[[1,"acl-matrix-root"],[1,"acl-matrix-scroll"],[1,"acl-matrix-controls"],[1,"acl-matrix-header"],[1,"section-title"],[1,"section-subtitle"],[1,"header-actions"],["mat-flat-button","",3,"click",4,"ngIf"],[4,"ngIf"],["class","edit-banner",4,"ngIf"],["class","loading-hint",4,"ngIf"],[1,"matrix"],[1,"perm-col","sticky-header"],["class","role-col sticky-header",4,"ngFor","ngForOf"],[4,"ngFor","ngForOf"],["mat-flat-button","",3,"click"],["mat-stroked-button","",3,"click"],["mat-flat-button","","color","primary",3,"click","disabled"],[1,"edit-banner"],["class","pending-pill",4,"ngIf"],[1,"pending-pill"],[1,"loading-hint"],[1,"role-col","sticky-header"],[1,"module-row"],[1,"perm-col"],[1,"perm-label"],[1,"perm-code"],["class","perm-cell","tabindex","0",3,"pending-add","pending-remove","click","keydown.enter","keydown.space",4,"ngFor","ngForOf"],["tabindex","0",1,"perm-cell",3,"click","keydown.enter","keydown.space"],["class","icon add",4,"ngIf"],["class","icon remove",4,"ngIf"],[3,"granted","denied",4,"ngIf"],[1,"icon","add"],[1,"icon","remove"]],template:function(e,n){e&1&&(a(0,"div",0)(1,"div",1)(2,"div",2)(3,"div",3)(4,"div")(5,"h2",4),s(6,"Role / Permission Matrix"),o(),a(7,"p",5),s(8," Configure which roles are allowed to access each API capability "),o()(),a(9,"div",6),p(10,pe,2,0,"button",7)(11,me,5,1,"ng-container",8),o()(),p(12,_e,4,1,"div",9),o(),p(13,fe,2,0,"div",10),a(14,"table",11)(15,"thead")(16,"tr")(17,"th",12),s(18,"Permission"),o(),p(19,xe,2,1,"th",13),o()(),a(20,"tbody"),p(21,be,5,3,"ng-container",14),o()()()()),e&2&&(l(10),d("ngIf",!n.editMode),l(),d("ngIf",n.editMode),l(),d("ngIf",n.editMode),l(),d("ngIf",n.loadingMatrix),l(),h("loading-surface",n.loadingMatrix),l(5),d("ngForOf",n.orderedRoles()),l(2),d("ngForOf",n.groupedPermissions()))},dependencies:[O,P,N,q],styles:['@charset "UTF-8";.acl-matrix-root[_ngcontent-%COMP%]{display:flex;flex-direction:column}.acl-matrix-scroll[_ngcontent-%COMP%]{max-height:calc(100vh - 140px);overflow-y:auto;overflow-x:auto;border:1px solid var(--border);border-radius:8px;background:var(--surface)}.acl-matrix-controls[_ngcontent-%COMP%]{position:sticky;top:0;z-index:30;background:var(--surface);padding:12px;border-bottom:1px solid var(--border)}.acl-matrix-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:flex-start;gap:16px}.section-title[_ngcontent-%COMP%]{font-size:1.125rem;font-weight:600}.section-subtitle[_ngcontent-%COMP%]{font-size:.875rem;color:var(--text-secondary)}.header-actions[_ngcontent-%COMP%]{display:flex;gap:8px;flex-shrink:0}.edit-banner[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;margin-top:8px;padding:10px 12px;background:var(--surface-hover);border:1px solid var(--border);border-radius:6px}.pending-pill[_ngcontent-%COMP%]{background:#f59e0b38;color:#92400e;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:600}.matrix[_ngcontent-%COMP%]{width:100%;min-width:820px;table-layout:fixed;border-collapse:collapse;font-size:.875rem}.sticky-header[_ngcontent-%COMP%]{position:sticky;top:116px;z-index:20;background:var(--surface);border-bottom:1px solid var(--border)}th[_ngcontent-%COMP%], td[_ngcontent-%COMP%]{padding:8px;border-bottom:1px solid var(--border);vertical-align:middle;white-space:nowrap}.perm-col[_ngcontent-%COMP%]{width:clamp(260px,40%,360px);text-align:left}.role-col[_ngcontent-%COMP%], .perm-cell[_ngcontent-%COMP%]{width:96px;min-width:96px;text-align:center}.role-col[_ngcontent-%COMP%]{font-size:.75rem;letter-spacing:.02em;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.module-row[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{background:var(--surface-hover);font-size:11px;font-weight:600;text-transform:uppercase}.perm-label[_ngcontent-%COMP%]{font-weight:500}.perm-code[_ngcontent-%COMP%]{font-size:11px;color:var(--text-secondary);font-family:monospace}.perm-cell[_ngcontent-%COMP%]{cursor:pointer;-webkit-user-select:none;user-select:none;font-weight:600;transition:background-color .12s ease,box-shadow .12s ease}.perm-cell[_ngcontent-%COMP%]:hover{background:var(--surface-hover)}.perm-cell[_ngcontent-%COMP%]   .granted[_ngcontent-%COMP%]{color:var(--text-success)}.perm-cell[_ngcontent-%COMP%]   .denied[_ngcontent-%COMP%]{color:var(--text-secondary)}.perm-cell.pending-add[_ngcontent-%COMP%]{background:#22c55e38;box-shadow:inset 0 0 0 1px #22c55e99}.perm-cell.pending-remove[_ngcontent-%COMP%]{background:#ef444438;box-shadow:inset 0 0 0 1px #ef444499}.icon[_ngcontent-%COMP%]{font-weight:700}.icon.add[_ngcontent-%COMP%]{color:#16a34a}.icon.remove[_ngcontent-%COMP%]{color:#dc2626}.perm-cell[_ngcontent-%COMP%]:focus-visible{outline:2px solid var(--active);outline-offset:-2px}']})};export{re as AclRoleMatrixComponent};
