import{a as H}from"./chunk-OCQ5HBIT.js";import{b as O,c as F}from"./chunk-TLF4YXFY.js";import{a as B,b as z}from"./chunk-SNZ3II6O.js";import{c as q,d as W}from"./chunk-CZGJLEOY.js";import{b as L,e as Y,h as G,i as j}from"./chunk-J5IGF7DT.js";import"./chunk-SGYCFQGT.js";import{d as E,f as w,h as M,i as I,p as V,s as R,v as T,x as D}from"./chunk-D2WFNIGL.js";import"./chunk-AYMLXUSV.js";import{f as N,g as A,h as $}from"./chunk-SRBP6AOE.js";import"./chunk-AQVBCBXZ.js";import{d as k}from"./chunk-CSKLPVDL.js";import"./chunk-Z7QKINIM.js";import"./chunk-5DTMLZHP.js";import{$c as S,Ib as t,Jb as i,Kb as h,Lb as v,Mb as _,Ob as x,Qb as m,Rb as c,Sc as P,ac as n,bb as s,bc as g,cc as y,ea as u,na as p,nb as b,oa as f,sb as C,zb as l}from"./chunk-KLCDKTJS.js";import"./chunk-FJYW2LMB.js";function K(d,o){if(d&1){let e=x();v(0),t(1,"div",13),n(2," We sent a verification code to "),t(3,"strong"),n(4),i()(),t(5,"mat-form-field",14)(6,"mat-label"),n(7,"Verification code"),i(),h(8,"input",15),i(),t(9,"div",16)(10,"span",17),n(11),i(),t(12,"button",18),m("click",function(){p(e);let a=c();return f(a.resendCode())}),n(13," Resend code "),i()(),t(14,"button",19),m("click",function(){p(e);let a=c();return f(a.verifyCode())}),n(15," Verify code "),i(),_()}if(d&2){let e=c();s(4),g(e.maskedDestination),s(7),y(" Code expires in ",e.countdownLabel," "),s(),l("disabled",e.remainingSeconds>0),s(2),l("disabled",e.verifyDisabled)}}function Q(d,o){if(d&1){let e=x();v(0),t(1,"mat-form-field",14)(2,"mat-label"),n(3,"New password"),i(),h(4,"input",20),t(5,"button",21),m("click",function(){p(e);let a=c();return f(a.hidePw=!a.hidePw)}),t(6,"mat-icon"),n(7),i()()(),t(8,"mat-form-field",14)(9,"mat-label"),n(10,"Confirm password"),i(),h(11,"input",22),t(12,"button",21),m("click",function(){p(e);let a=c();return f(a.hideConfirm=!a.hideConfirm)}),t(13,"mat-icon"),n(14),i()()(),t(15,"button",19),m("click",function(){p(e);let a=c();return f(a.submit())}),n(16," Reset password "),i(),_()}if(d&2){let e=c();s(4),l("type",e.hidePw?"password":"text"),s(3),g(e.hidePw?"visibility":"visibility_off"),s(4),l("type",e.hideConfirm?"password":"text"),s(3),g(e.hideConfirm?"visibility":"visibility_off"),s(),l("disabled",e.loading)}}var J=class d{fb=u(T);reset=u(H);router=u(k);snack=u(B);state=history.state;step="VERIFY";loading=!1;verifyDisabled=!1;hidePw=!0;hideConfirm=!0;otpExpirySeconds=15*60;remainingSeconds=this.otpExpirySeconds;timerId;form=this.fb.nonNullable.group({token:["",w.required],newPassword:[""],confirmPassword:[""]},{validators:o=>{let e=o.get("newPassword").value,r=o.get("confirmPassword").value;return e&&r&&e!==r?{mismatch:!0}:null}});ngOnInit(){this.startCountdown()}ngOnDestroy(){this.clearTimer()}verifyCode(){this.form.controls.token.invalid||this.verifyDisabled||(this.verifyDisabled=!0,this.reset.verifyToken({token:this.form.value.token}).subscribe({next:()=>{this.step="RESET",this.form.controls.newPassword.setValidators([w.required]),this.form.controls.confirmPassword.setValidators([w.required]),this.form.controls.newPassword.updateValueAndValidity(),this.form.controls.confirmPassword.updateValueAndValidity(),this.snack.open("Code verified. Please set a new password.","Close",{duration:3e3})},error:()=>{this.verifyDisabled=!1,this.snack.open("Invalid or expired verification code.","Close",{duration:3500})}}))}resendCode(){this.reset.initiate({identifier:this.state.identifier,channel:this.state.channel}).subscribe({complete:()=>{},error:()=>{}}),this.remainingSeconds=this.otpExpirySeconds,this.startCountdown(),this.verifyDisabled=!1,this.form.controls.token.reset(),this.step="VERIFY",this.snack.open(this.state.channel==="EMAIL"?"A new verification code has been sent to your email.":"A new verification code has been sent to your phone.","Close",{duration:4e3})}submit(){if(this.form.invalid)return;this.loading=!0;let o={token:this.form.value.token,newPassword:this.form.value.newPassword};this.reset.completeWithToken(o).subscribe({next:()=>{this.snack.open("Password reset successful. You can now log in.","Close",{duration:3e3}),this.finish()},error:()=>{this.snack.open("Password reset failed. Please try again.","Close",{duration:3500}),this.loading=!1}})}startCountdown(){this.clearTimer(),this.timerId=window.setInterval(()=>{this.remainingSeconds>0?this.remainingSeconds--:this.clearTimer()},1e3)}clearTimer(){this.timerId&&(clearInterval(this.timerId),this.timerId=void 0)}get countdownLabel(){let o=Math.floor(this.remainingSeconds/60),e=this.remainingSeconds%60;return`${o}:${e.toString().padStart(2,"0")}`}get maskedDestination(){return this.state.channel==="EMAIL"?this.maskEmail(this.state.identifier):this.state.channel==="SMS"?this.maskPhone(this.state.identifier):"your registered account details"}maskEmail(o){if(!o||!o.includes("@"))return"your registered email";let[e,r]=o.split("@");return e.length<=1?`*@${r}`:`${e.charAt(0)}***@${r}`}maskPhone(o){let e=o.replace(/\D/g,"");return e.length<7?"your registered phone":`+${e.slice(0,3)}***${e.slice(-3)}`}finish(){this.clearTimer(),this.loading=!1,this.router.navigate(["/login"])}cancel(){this.finish()}static \u0275fac=function(e){return new(e||d)};static \u0275cmp=b({type:d,selectors:[["app-reset-password"]],decls:19,vars:3,consts:[[1,"auth-root"],[1,"auth-card",3,"formGroup"],[1,"dialog-header"],[1,"dialog-title"],[1,"dialog-subtitle"],[1,"form-section"],[1,"section-label"],[1,"form-grid"],[4,"ngIf"],[1,"dialog-footer"],[1,"footer-hint"],[1,"footer-actions"],["mat-stroked-button","",3,"click"],[1,"destination-hint"],["appearance","fill"],["matInput","","formControlName","token"],[1,"otp-meta"],[1,"countdown"],["mat-button","","type","button",3,"click","disabled"],["mat-flat-button","","color","primary",3,"click","disabled"],["matInput","","formControlName","newPassword",3,"type"],["mat-icon-button","","matSuffix","","type","button",3,"click"],["matInput","","formControlName","confirmPassword",3,"type"]],template:function(e,r){e&1&&(t(0,"div",0)(1,"div",1)(2,"header",2)(3,"div",3),n(4,"Reset password"),i(),t(5,"div",4),n(6," Enter the verification code and choose a new password "),i()(),t(7,"section",5)(8,"div",6),n(9,"Verification"),i(),t(10,"div",7),C(11,K,16,4,"ng-container",8)(12,Q,17,5,"ng-container",8),i()(),t(13,"footer",9)(14,"div",10),n(15," Password changes invalidate all active sessions "),i(),t(16,"div",11)(17,"button",12),m("click",function(){return r.cancel()}),n(18,"Cancel"),i()()()()()),e&2&&(s(),l("formGroup",r.form),s(10),l("ngIf",r.step==="VERIFY"),s(),l("ngIf",r.step==="RESET"))},dependencies:[S,P,D,E,M,I,V,R,j,G,L,Y,W,q,$,A,N,F,O,z],styles:[".auth-root[_ngcontent-%COMP%]{min-height:100vh;display:flex;align-items:center;justify-content:center;background:var(--app-bg);padding:24px}.auth-card[_ngcontent-%COMP%]{width:100%;max-width:600px;background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:32px;box-shadow:0 12px 32px #00000014}.dialog-header[_ngcontent-%COMP%]{margin-bottom:24px}.dialog-title[_ngcontent-%COMP%]{font-size:1.4rem;font-weight:600}.dialog-subtitle[_ngcontent-%COMP%]{font-size:.9rem;color:var(--text-secondary)}.form-section[_ngcontent-%COMP%]{margin-top:12px}.section-label[_ngcontent-%COMP%]{font-size:.7rem;text-transform:uppercase;color:var(--text-secondary);margin-bottom:12px}.form-grid[_ngcontent-%COMP%]{display:grid;gap:16px}.dialog-footer[_ngcontent-%COMP%]{margin-top:32px;display:flex;justify-content:space-between;align-items:center}.footer-hint[_ngcontent-%COMP%]{font-size:.75rem;color:var(--text-secondary)}.destination-hint[_ngcontent-%COMP%]{font-size:.85rem;color:var(--text-secondary);margin-bottom:12px}"]})};export{J as ResetPasswordComponent};
