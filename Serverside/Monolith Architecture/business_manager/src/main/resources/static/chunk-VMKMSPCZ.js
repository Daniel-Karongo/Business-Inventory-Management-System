import{a as _e}from"./chunk-AASPAG7H.js";import{a as te,c as ie,e as ne,f as ae,g as oe,h as re}from"./chunk-G6DPSII6.js";import{a as X,b as Z}from"./chunk-GQKP7E5B.js";import{a as fe,b as ue}from"./chunk-H37LQHOQ.js";import{d as z}from"./chunk-DF6WYVPK.js";import{b as Q,c as O}from"./chunk-F3TBVMOI.js";import{a as le}from"./chunk-BIVTK5YB.js";import{c as pe,d as ge}from"./chunk-ZFWGKVXC.js";import{a as ce}from"./chunk-CONPK5ZF.js";import{b as de,c as me,h as se}from"./chunk-3ZV2DC5Q.js";import{d as H,f as E,h as G,i as q,p as W,s as Y,v as J,x as K}from"./chunk-Z2GGFO6C.js";import{f as ee,g as w,h as D}from"./chunk-TENNXE3V.js";import{$b as V,Bb as S,Ib as o,Jb as a,Kb as T,Lb as F,Mb as A,Ob as v,Qb as p,Rb as s,Tc as C,Uc as h,Yc as $,Za as b,ac as d,bb as r,bc as y,bd as M,cc as x,dc as R,gb as _,la as N,ma as f,na as u,nb as I,pc as B,rc as L,sb as c,tc as j,zb as m}from"./chunk-3DYKM6ZU.js";import{a as k,b as U}from"./chunk-FJYW2LMB.js";function he(i,t){if(i&1&&(o(0,"div",11),T(1,"img",12),a()),i&2){let e=s();r(),m("src",e.previewUrl,b)}}function Me(i,t){if(i&1&&(o(0,"mat-option",13),d(1),a()),i&2){let e=t.$implicit;m("value",e),r(),x(" ",e," ")}}function Ee(i,t){i&1&&(o(0,"mat-error"),d(1," Please enter at least 3 characters "),a())}function Oe(i,t){if(i&1&&(o(0,"mat-form-field",4)(1,"mat-label"),d(2,"Enter description"),a(),T(3,"input",14),c(4,Ee,2,0,"mat-error",15),a()),i&2){let e,n=s();r(4),m("ngIf",(e=n.fg.get("custom"))==null?null:e.invalid)}}var P=class i{constructor(t,e){this.dialogRef=t;this.fb=e;this.fg=this.fb.group({type:["ID",E.required],custom:[""]}),this.fg.get("type").valueChanges.subscribe(n=>{let l=this.fg.get("custom");n==="Other"?l?.setValidators([E.required,E.minLength(3)]):(l?.clearValidators(),l?.setValue("")),l?.updateValueAndValidity()})}file;previewUrl;descriptionOptions=["ID","Passport","Signature","CV","Other"];fg;onFileSelected(t){let n=t.target.files?.[0];n&&(this.file=n,this.previewUrl=n.type.startsWith("image/")?URL.createObjectURL(n):void 0)}confirm(){if(!this.file||this.fg.invalid)return;let t=this.fg.value.type,e=t==="Other"?this.fg.value.custom:t;this.dialogRef.close({file:this.file,description:e})}cancel(){this.dialogRef.close()}static \u0275fac=function(e){return new(e||i)(_(te),_(J))};static \u0275cmp=I({type:i,selectors:[["app-image-upload-dialog"]],decls:16,vars:5,consts:[["mat-dialog-title",""],["mat-dialog-content","",1,"content",3,"formGroup"],["type","file","accept","image/*,application/pdf",3,"change"],["class","preview",4,"ngIf"],["appearance","fill",1,"full"],["formControlName","type"],[3,"value",4,"ngFor","ngForOf"],["appearance","fill","class","full",4,"ngIf"],["mat-dialog-actions","","align","end"],["mat-button","",3,"click"],["mat-flat-button","","color","primary",3,"click","disabled"],[1,"preview"],[3,"src"],[3,"value"],["matInput","","formControlName","custom"],[4,"ngIf"]],template:function(e,n){if(e&1&&(o(0,"h2",0),d(1,"Upload Image"),a(),o(2,"div",1)(3,"input",2),p("change",function(g){return n.onFileSelected(g)}),a(),c(4,he,2,1,"div",3),o(5,"mat-form-field",4)(6,"mat-label"),d(7,"Description"),a(),o(8,"mat-select",5),c(9,Me,2,2,"mat-option",6),a()(),c(10,Oe,5,1,"mat-form-field",7),a(),o(11,"div",8)(12,"button",9),p("click",function(){return n.cancel()}),d(13,"Cancel"),a(),o(14,"button",10),p("click",function(){return n.confirm()}),d(15," Upload "),a()()),e&2){let l;r(2),m("formGroup",n.fg),r(2),m("ngIf",n.previewUrl),r(5),m("ngForOf",n.descriptionOptions),r(),m("ngIf",((l=n.fg.get("type"))==null?null:l.value)==="Other"),r(4),m("disabled",!n.file||n.fg.invalid)}},dependencies:[M,C,h,K,H,G,q,W,Y,re,ne,oe,ae,D,w,O,ce,se,de,me,ge,pe,ue,fe,z],styles:[".content[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:1rem}.preview[_ngcontent-%COMP%]{display:flex;justify-content:center}.preview[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{max-width:100%;max-height:250px;border-radius:4px;border:1px solid var(--border)}.full[_ngcontent-%COMP%]{width:100%}"]})};function we(i,t){if(i&1){let e=v();o(0,"button",7),p("click",function(){f(e);let l=s();return u(l.triggerUpload())}),o(1,"mat-icon"),d(2,"upload"),a(),d(3," Upload "),a()}if(i&2){let e=s();m("disabled",e.uploading)}}function De(i,t){i&1&&(o(0,"div",8),d(1," No documents uploaded "),a())}function Pe(i,t){if(i&1){let e=v();F(0),o(1,"img",20),p("click",function(){f(e);let l=s().$implicit,g=s(2);return u(g.view(l))}),a(),A()}if(i&2){let e=s().$implicit,n=s(2);r(),m("src",n.imageUrl(e),b)}}function Se(i,t){if(i&1){let e=v();o(0,"div",21),p("click",function(){f(e);let l=s().$implicit,g=s(2);return u(g.view(l))}),o(1,"mat-icon"),d(2,"picture_as_pdf"),a(),o(3,"span"),d(4),a()()}if(i&2){let e=s().$implicit;r(4),y(e.fileName)}}function Te(i,t){if(i&1&&(o(0,"div",22),d(1),a()),i&2){let e=s().$implicit;r(),x(" ",e.description," ")}}function ke(i,t){i&1&&(o(0,"div",23),d(1,"Deleted"),a())}function Ue(i,t){if(i&1){let e=v();o(0,"button",24),p("click",function(){f(e);let l=s().$implicit,g=s(2);return u(g.hardDelete(l))}),o(1,"mat-icon"),d(2,"delete_forever"),a()()}}function Ne(i,t){if(i&1){let e=v();o(0,"div",11),c(1,Pe,2,1,"ng-container",12)(2,Se,5,1,"ng-template",null,0,j),o(4,"div",13)(5,"div",14),d(6),a(),c(7,Te,2,1,"div",15)(8,ke,2,0,"div",16),a(),o(9,"div",17)(10,"button",18),p("click",function(){let l=f(e).$implicit,g=s(2);return u(g.primaryAction(l))}),o(11,"mat-icon"),d(12),a()(),c(13,Ue,3,0,"button",19),a()()}if(i&2){let e=t.$implicit,n=V(3),l=s(2);S("deleted",e.deleted),r(),m("ngIf",e.image)("ngIfElse",n),r(5),y(e.fileName),r(),m("ngIf",e.description),r(),m("ngIf",e.deleted),r(2),m("matTooltip",e.deleted?"Restore document":"Delete document"),r(2),y(e.deleted?"restore":"delete"),r(),m("ngIf",e.deleted&&l.allowHardDelete)}}function Fe(i,t){if(i&1&&(o(0,"div",9),c(1,Ne,14,10,"div",10),a()),i&2){let e=s();r(),m("ngForOf",e.images)}}function Ae(i,t){if(i&1&&(o(0,"div",30)(1,"div",31)(2,"div",32),d(3),a(),o(4,"div",33),d(5),B(6,"date"),a()(),o(7,"div",34),d(8),a()()),i&2){let e=t.$implicit;r(3),y(e.fileName),r(2),R(" ",e.performedByUsername," \u2022 ",L(6,12,e.timestamp,"medium")," "),r(2),S("upload",e.action==="UPLOAD")("delete",e.action==="DELETE")("restore",e.action==="RESTORE")("hard",e.action==="HARD_DELETE"),r(),x(" ",e.action," ")}}function Ve(i,t){if(i&1&&(o(0,"details",25)(1,"summary",26),d(2," Document Audit Log "),o(3,"span",27),d(4),a()(),o(5,"div",28),c(6,Ae,9,15,"div",29),a()()),i&2){let e=s();r(4),x("(",e.audits.length,")"),r(2),m("ngForOf",e.audits)}}var ve=class i{constructor(t,e){this.snackbar=t;this.dialog=e}entityId;adapter;allowHardDelete=!1;readonly=!1;images=[];audits=[];loading=!0;loadingAudits=!1;uploading=!1;imageUrlMap=new Map;ngOnInit(){this.entityId&&this.loadAll()}ngOnChanges(){this.entityId&&this.loadAll()}loadAll(){this.loadImages(),this.loadAudits()}loadImages(){this.loading=!0,this.adapter.listImages(this.entityId).subscribe({next:t=>{this.images=this.enrichTypes(t||[]),this.images.filter(e=>e.image).forEach(e=>this.loadBlob(e)),this.loading=!1},error:()=>{this.snackbar.open("Failed to load documents","Close",{duration:3e3}),this.loading=!1}})}loadAudits(){this.loadingAudits=!0,console.log("Hello"),console.log(this.entityId),this.adapter.listImageAudits(this.entityId).subscribe({next:t=>{console.log(t),this.audits=t??[],this.loadingAudits=!1},error:()=>{this.loadingAudits=!1}})}loadBlob(t){this.adapter.getImageBlob(this.entityId,t.fileName,t.deleted).subscribe(e=>{let n=URL.createObjectURL(e);this.imageUrlMap.set(t.fileName,n)})}imageUrl(t){return this.imageUrlMap.get(t.fileName)??""}enrichTypes(t){return t.map(e=>{let n=e.fileName.split(".").pop()?.toLowerCase()??"";return U(k({},e),{image:["jpg","jpeg","png","gif","webp"].includes(n),pdf:n==="pdf"})})}view(t){if(t.image){let e=this.imageUrl(t);if(!e)return;this.dialog.open(_e,{data:{preview:{src:e,name:t.fileName,type:"image"}},width:"80%",maxWidth:"1100px"});return}t.pdf&&this.openPdf(t)}openPdf(t){this.adapter.getImageBlob(this.entityId,t.fileName,t.deleted).subscribe(e=>{let n=new Blob([e],{type:"application/pdf"}),l=URL.createObjectURL(n);window.open(l,"_blank"),setTimeout(()=>URL.revokeObjectURL(l),6e4)})}triggerUpload(){this.dialog.open(P,{width:"420px"}).afterClosed().subscribe(t=>{t&&(this.uploading=!0,this.adapter.uploadImages(this.entityId,[t]).subscribe({next:()=>{this.uploading=!1,this.loadAll(),this.snackbar.open("Document uploaded","Close",{duration:2e3})},error:()=>{this.uploading=!1,this.snackbar.open("Upload failed","Close",{duration:3e3})}}))})}primaryAction(t){(t.deleted?this.adapter.restoreImage(this.entityId,t.fileName):this.adapter.softDeleteImage(this.entityId,t.fileName)).subscribe(()=>{this.snackbar.open(t.deleted?"Document restored":"Document deleted","Close",{duration:2e3}),this.loadAll()})}hardDelete(t){this.adapter.hardDeleteImage(this.entityId,t.fileName).subscribe(()=>{this.snackbar.open("Document permanently deleted","Close",{duration:2e3}),this.loadAll()})}static \u0275fac=function(e){return new(e||i)(_(le),_(ie))};static \u0275cmp=I({type:i,selectors:[["app-entity-image-manager"]],inputs:{entityId:"entityId",adapter:"adapter",allowHardDelete:"allowHardDelete",readonly:"readonly"},features:[N],decls:8,vars:4,consts:[["pdfTpl",""],[1,"p-4"],[1,"toolbar"],["mat-flat-button","","color","primary",3,"disabled","click",4,"ngIf"],["class","empty",4,"ngIf"],["class","image-grid",4,"ngIf"],["class","audit-section",4,"ngIf"],["mat-flat-button","","color","primary",3,"click","disabled"],[1,"empty"],[1,"image-grid"],["class","image-card",3,"deleted",4,"ngFor","ngForOf"],[1,"image-card"],[4,"ngIf","ngIfElse"],[1,"image-meta"],[1,"filename"],["class","description",4,"ngIf"],["class","deleted",4,"ngIf"],[1,"actions"],["mat-icon-button","",3,"click","matTooltip"],["mat-icon-button","","color","warn","matTooltip","Delete permanently",3,"click",4,"ngIf"],[1,"clickable-image",3,"click","src"],[1,"pdf-card",3,"click"],[1,"description"],[1,"deleted"],["mat-icon-button","","color","warn","matTooltip","Delete permanently",3,"click"],[1,"audit-section"],[1,"audit-summary"],[1,"count"],[1,"audit-list"],["class","audit-row",4,"ngFor","ngForOf"],[1,"audit-row"],[1,"audit-left"],[1,"audit-file"],[1,"audit-meta"],[1,"audit-action"]],template:function(e,n){e&1&&(o(0,"div",1)(1,"div",2)(2,"h3"),d(3,"Documents"),a(),c(4,we,4,1,"button",3),a(),c(5,De,2,0,"div",4)(6,Fe,2,1,"div",5)(7,Ve,7,2,"details",6),a()),e&2&&(r(4),m("ngIf",!n.readonly),r(),m("ngIf",!n.loading&&n.images.length===0),r(),m("ngIf",!n.loading),r(),m("ngIf",!n.loadingAudits&&n.audits.length))},dependencies:[M,C,h,$,D,w,ee,O,Q,Z,X],styles:["[_nghost-%COMP%]{display:block}.toolbar[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}.toolbar[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0;font-size:1rem;font-weight:600}.image-grid[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px}.image-card[_ngcontent-%COMP%]{padding:10px;transition:transform .15s ease,box-shadow .15s ease,border-color .15s ease}.image-card[_ngcontent-%COMP%]:hover{transform:translateY(-5px);box-shadow:0 6px 16px #0000001f;border-color:var(--active)}body.dark[_ngcontent-%COMP%]   .image-card[_ngcontent-%COMP%]:hover{box-shadow:0 6px 18px #00000073}.image-card[_ngcontent-%COMP%]{border:1px solid var(--border);border-radius:6px;background:var(--surface);overflow:hidden;position:relative}.image-card[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{width:100%;height:140px;object-fit:cover}.pdf-card[_ngcontent-%COMP%]{height:140px;display:flex;flex-direction:column;align-items:center;justify-content:center;color:var(--text-secondary);gap:6px}.image-meta[_ngcontent-%COMP%]{padding:8px;font-size:.75rem}.image-meta[_ngcontent-%COMP%]   .filename[_ngcontent-%COMP%]{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.image-meta[_ngcontent-%COMP%]   .description[_ngcontent-%COMP%]{color:var(--text-secondary);margin-top:2px}.delete-btn[_ngcontent-%COMP%]{position:absolute;top:6px;right:6px;background:#0009;border-radius:50%;padding:4px;opacity:0;transition:opacity .15s}.image-card[_ngcontent-%COMP%]:hover   .delete-btn[_ngcontent-%COMP%]{opacity:1}.clickable-image[_ngcontent-%COMP%]{cursor:pointer;transition:transform .15s}.clickable-image[_ngcontent-%COMP%]:hover{transform:scale(1.02)}.audit-section[_ngcontent-%COMP%]{margin-top:32px;border-top:1px solid var(--border);padding-top:16px}.audit-title[_ngcontent-%COMP%]{font-size:.9rem;font-weight:600;margin-bottom:12px}.audit-list[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:8px}.audit-row[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:var(--surface);border:1px solid var(--border);border-radius:6px;font-size:.8rem}.audit-left[_ngcontent-%COMP%]{display:flex;flex-direction:column}.audit-file[_ngcontent-%COMP%]{font-weight:600}.audit-meta[_ngcontent-%COMP%]{color:var(--text-secondary);font-size:.75rem}.audit-action[_ngcontent-%COMP%]{font-weight:600;padding:4px 8px;border-radius:4px}.audit-action.upload[_ngcontent-%COMP%]{color:var(--text-success)}.audit-action.delete[_ngcontent-%COMP%]{color:#ef4444}.audit-action.restore[_ngcontent-%COMP%]{color:#3b82f6}.image-card.deleted[_ngcontent-%COMP%]{opacity:.55}.image-card.deleted[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{filter:grayscale(1)}.audit-summary[_ngcontent-%COMP%]{cursor:pointer;font-weight:600;margin-bottom:8px}.audit-summary[_ngcontent-%COMP%]   .count[_ngcontent-%COMP%]{font-size:.75rem;color:var(--text-secondary);margin-left:6px}"]})};export{ve as a};
