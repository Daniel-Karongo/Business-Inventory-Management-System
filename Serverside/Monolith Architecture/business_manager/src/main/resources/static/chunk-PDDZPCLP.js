import{a as j,b as B,c as U,d as J,e as G,f as V,g as Y,h as q,i as K,j as Q,k as W}from"./chunk-IFBDMVRJ.js";import{a as H,b as L}from"./chunk-JNUXAAQA.js";import"./chunk-2CD73GIG.js";import{b as z,c as C}from"./chunk-NP55MDY3.js";import"./chunk-SGYCFQGT.js";import"./chunk-CN565FBG.js";import{g as F,h as $}from"./chunk-A6LP6NU3.js";import"./chunk-7XXZ3FER.js";import"./chunk-LMLMO6HS.js";import{a as h}from"./chunk-5DTMLZHP.js";import{$c as v,Ib as n,Jb as i,Kb as f,Lb as b,Mb as O,Qb as A,Qc as T,Rb as M,Rc as D,Sc as k,Wc as N,Z as w,ac as a,bb as l,bc as m,cc as E,da as p,dc as I,hd as g,la as S,nb as u,nc as R,pc as P,sb as c,zb as d}from"./chunk-IL4QWM46.js";import"./chunk-FJYW2LMB.js";var y=class e{http=p(g);base=`${h.apiUrl}/admin/acl`;getSummary(){return this.http.get(`${this.base}/summary`)}getRecentAudits(t=20){return this.http.get(`${this.base}/audits`,{params:{limit:t}})}refreshCache(){return this.http.post(`${this.base}/cache/refresh`,{})}static \u0275fac=function(o){return new(o||e)};static \u0275prov=w({token:e,factory:e.\u0275fac,providedIn:"root"})};function te(e,t){e&1&&(n(0,"div",5),a(1," Fetching audit history\u2026 "),i())}function ie(e,t){e&1&&(n(0,"div",6),a(1," No audit records found "),i())}function ne(e,t){if(e&1&&(n(0,"div",9)(1,"div",10)(2,"span",11),a(3),i()(),n(4,"div",12)(5,"div",13)(6,"span",14),a(7),i(),n(8,"span",15),a(9),R(10,"date"),i()(),n(11,"div",16)(12,"div",17)(13,"div",18),a(14,"Before"),i(),n(15,"pre"),a(16),i()(),n(17,"div",17)(18,"div",18),a(19,"After"),i(),n(20,"pre"),a(21),i()()()()()),e&2){let o,r,s=t.$implicit,_=M(2);l(2),d("ngClass",_.badgeClass(s.action)),l(),E(" ",s.action," "),l(4),I(" ",s.actorUsername," \xB7 ",s.actorRole," "),l(2),E(" ",P(10,7,s.createdAt,"dd/MM/yyyy HH:mm:ss")," "),l(7),m((o=_.parse(s.beforeState))!==null&&o!==void 0?o:"\u2014"),l(5),m((r=_.parse(s.afterState))!==null&&r!==void 0?r:"\u2014")}}function ae(e,t){if(e&1&&(n(0,"div",7),c(1,ne,22,10,"div",8),i()),e&2){let o=M();l(),d("ngForOf",o.audits)}}var x=class e{http=p(g);entityType;entityId;loading=!1;audits=[];ngOnChanges(){!this.entityType||!this.entityId||this.load()}load(){this.loading=!0,this.http.get(`${h.apiUrl}/admin/acl/audits/${this.entityType}/${this.entityId}`).subscribe({next:t=>{this.audits=t??[],this.loading=!1},error:()=>this.loading=!1})}parse(t){if(!t)return null;if(t.includes("serialization_failed"))return"\u26A0 Serialization failed";try{return JSON.stringify(JSON.parse(t),null,2)}catch{return"\u26A0 Invalid JSON"}}badgeClass(t){return t.toLowerCase()}static \u0275fac=function(o){return new(o||e)};static \u0275cmp=u({type:e,selectors:[["app-acl-audit-timeline"]],inputs:{entityType:"entityType",entityId:"entityId"},features:[S],decls:6,vars:3,consts:[[1,"audit-surface"],[1,"section-title"],["class","loading-hint",4,"ngIf"],["class","audit-empty",4,"ngIf"],["class","audit-timeline",4,"ngIf"],[1,"loading-hint"],[1,"audit-empty"],[1,"audit-timeline"],["class","audit-entry",4,"ngFor","ngForOf"],[1,"audit-entry"],[1,"audit-marker"],[1,"action-pill",3,"ngClass"],[1,"audit-body"],[1,"audit-header"],[1,"actor"],[1,"time"],[1,"audit-diff"],[1,"diff-block"],[1,"diff-title"]],template:function(o,r){o&1&&(n(0,"div",0)(1,"h3",1),a(2,"Recent ACL Activity"),i(),c(3,te,2,0,"div",2)(4,ie,2,0,"div",3)(5,ae,2,1,"div",4),i()),o&2&&(l(3),d("ngIf",r.loading),l(),d("ngIf",!r.loading&&!r.audits.length),l(),d("ngIf",r.audits.length))},dependencies:[v,T,D,k,N,C],styles:[".audit-surface[_ngcontent-%COMP%]{background:var(--surface);border-radius:10px;padding:16px;box-shadow:var(--surface-shadow)}.section-title[_ngcontent-%COMP%]{font-size:1.125rem;font-weight:600;margin-bottom:12px}.audit-loading[_ngcontent-%COMP%], .audit-empty[_ngcontent-%COMP%]{font-size:.875rem;color:var(--text-secondary);padding:12px}.audit-timeline[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:14px}.audit-entry[_ngcontent-%COMP%]{display:grid;grid-template-columns:90px 1fr;gap:12px}.audit-marker[_ngcontent-%COMP%]{display:flex;justify-content:flex-end}.action-pill[_ngcontent-%COMP%]{padding:4px 10px;border-radius:999px;font-size:11px;font-weight:700;letter-spacing:.04em}.action-pill.create[_ngcontent-%COMP%]{background:#22c55e33;color:#15803d}.action-pill.update[_ngcontent-%COMP%]{background:#3b82f633;color:#1d4ed8}.action-pill.delete[_ngcontent-%COMP%], .action-pill.deactivate[_ngcontent-%COMP%]{background:#ef444438;color:#991b1b}.audit-body[_ngcontent-%COMP%]{border:1px solid var(--border);border-radius:8px;padding:12px;background:var(--surface-hover)}.audit-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;font-size:.75rem;color:var(--text-secondary);margin-bottom:8px}.audit-diff[_ngcontent-%COMP%]{display:grid;grid-template-columns:1fr 1fr;gap:12px}.diff-block[_ngcontent-%COMP%]{background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:8px}.diff-title[_ngcontent-%COMP%]{font-size:11px;font-weight:600;color:var(--text-secondary);margin-bottom:4px}pre[_ngcontent-%COMP%]{margin:0;font-size:.75rem;font-family:ui-monospace,SFMono-Regular,Menlo,monospace;white-space:pre-wrap}"]})};function oe(e,t){e&1&&(n(0,"th",18),a(1,"Role"),i())}function re(e,t){if(e&1&&(n(0,"td",19),a(1),i()),e&2){let o=t.$implicit;l(),m(o.role)}}function le(e,t){e&1&&(n(0,"th",18),a(1,"Permissions"),i())}function de(e,t){if(e&1&&(n(0,"td",19),a(1),i()),e&2){let o=t.$implicit;l(),m(o.count)}}function me(e,t){e&1&&f(0,"tr",20)}function se(e,t){e&1&&f(0,"tr",21)}var Z=class e{acl=p(y);summary;audits=[];roleColumns=["role","count"];auditColumns=["time","entity","action","actor"];ROLE_ORDER=["SUPERUSER","ADMIN","MANAGER","SUPERVISOR","EMPLOYEE"];ngOnInit(){this.load()}load(){this.acl.getSummary().subscribe(t=>this.summary=t),this.acl.getRecentAudits().subscribe(t=>this.audits=t)}refreshCache(){this.acl.refreshCache().subscribe(()=>this.load())}roleEntries(){return Object.entries(this.summary?.rolePermissionCounts??{}).map(([o,r])=>({role:o,count:r})).sort((o,r)=>this.ROLE_ORDER.indexOf(o.role)-this.ROLE_ORDER.indexOf(r.role))}static \u0275fac=function(o){return new(o||e)};static \u0275cmp=u({type:e,selectors:[["app-acl-overview"]],decls:40,vars:6,consts:[[1,"space-y-6"],[1,"flex","items-center","justify-between"],[1,"text-lg","font-semibold"],["mat-flat-button","","matTooltip","Reload ACL cache without restart",3,"click"],[1,"grid","grid-cols-1","md:grid-cols-3","gap-4"],[1,"surface"],[1,"label"],[1,"value"],[1,"surface","p-4"],[1,"section-title"],["mat-table","",3,"dataSource"],["matColumnDef","role"],["mat-header-cell","",4,"matHeaderCellDef"],["mat-cell","",4,"matCellDef"],["matColumnDef","count"],["mat-header-row","",4,"matHeaderRowDef"],["mat-row","",4,"matRowDef","matRowDefColumns"],["entityType","ACL","entityId","GLOBAL"],["mat-header-cell",""],["mat-cell",""],["mat-header-row",""],["mat-row",""]],template:function(o,r){o&1&&(n(0,"div",0)(1,"div",1)(2,"h2",2),a(3,"Access Control Overview"),i(),n(4,"button",3),A("click",function(){return r.refreshCache()}),n(5,"mat-icon"),a(6,"refresh"),i(),a(7," Refresh Cache "),i()(),n(8,"div",4)(9,"div",5)(10,"div",6),a(11,"Endpoints"),i(),n(12,"div",7),a(13),i()(),n(14,"div",5)(15,"div",6),a(16,"Permissions"),i(),n(17,"div",7),a(18),i()(),n(19,"div",5)(20,"div",6),a(21,"Roles"),i(),n(22,"div",7),a(23),i()()(),n(24,"div",8)(25,"h3",9),a(26,"Permissions per Role"),i(),n(27,"table",10),b(28,11),c(29,oe,2,0,"th",12)(30,re,2,1,"td",13),O(),b(31,14),c(32,le,2,0,"th",12)(33,de,2,1,"td",13),O(),c(34,me,1,0,"tr",15)(35,se,1,0,"tr",16),i()(),n(36,"div",8)(37,"h3",9),a(38,"Recent ACL Activity"),i(),f(39,"app-acl-audit-timeline",17),i()()),o&2&&(l(13),m(r.summary==null?null:r.summary.endpointCount),l(5),m(r.summary==null?null:r.summary.permissionCount),l(5),m(r.roleEntries().length),l(4),d("dataSource",r.roleEntries()),l(7),d("matHeaderRowDef",r.roleColumns),l(),d("matRowDefColumns",r.roleColumns))},dependencies:[v,$,F,W,j,U,Y,J,B,q,G,V,K,Q,C,z,L,H,x],styles:[".surface[_ngcontent-%COMP%]{background:var(--surface-bg);border:1px solid var(--surface-border);border-radius:var(--surface-radius);box-shadow:var(--surface-shadow);padding:16px}.label[_ngcontent-%COMP%]{font-size:var(--text-sm);color:var(--text-secondary)}.value[_ngcontent-%COMP%]{font-size:1.75rem;font-weight:var(--font-semibold)}.section-title[_ngcontent-%COMP%]{font-size:var(--text-base);font-weight:var(--font-medium);margin-bottom:12px}app-acl-audit-timeline[_ngcontent-%COMP%]{display:block;margin-top:16px}"]})};export{Z as AclOverviewComponent};
