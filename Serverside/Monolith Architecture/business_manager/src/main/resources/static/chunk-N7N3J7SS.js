import{c as j}from"./chunk-G6DPSII6.js";import"./chunk-MS4AQ6UA.js";import{a as U,b as B}from"./chunk-H37LQHOQ.js";import{c as L,d as $}from"./chunk-DF6WYVPK.js";import"./chunk-MJONFXFY.js";import"./chunk-CONPK5ZF.js";import"./chunk-3ZV2DC5Q.js";import"./chunk-SGYCFQGT.js";import"./chunk-Z2GGFO6C.js";import"./chunk-75T6YVBZ.js";import{g as G,h as W}from"./chunk-TENNXE3V.js";import"./chunk-2X53NFZU.js";import{a as N}from"./chunk-5DTMLZHP.js";import{$b as S,Bb as I,Ib as s,Jb as r,Kb as P,Lb as b,Mb as x,Ob as f,Qb as _,Rb as m,Tc as T,Uc as k,Z as A,ac as c,bb as l,bd as F,cc as E,da as C,dc as O,gc as y,hc as w,ic as M,jd as D,ma as d,na as p,nb as R,sb as u,tc as V,zb as a}from"./chunk-3DYKM6ZU.js";import"./chunk-FJYW2LMB.js";var h=class n{http=C(D);base=`${N.apiUrl}/admin/acl`;listPermissions(){return this.http.get(`${this.base}/permissions`)}listRoles(){return this.http.get(`${this.base}/roles`)}listConditions(i,e){return this.http.get(`${this.base}/permissions/${i}/conditions`,{params:{role:e}})}addCondition(i,e){return this.http.post(`${this.base}/permissions/${i}/conditions`,e)}softDeleteCondition(i,e){return this.http.delete(`${this.base}/conditions/${i}`,{body:{reason:e}})}static \u0275fac=function(e){return new(e||n)};static \u0275prov=A({token:n,factory:n.\u0275fac,providedIn:"root"})};function Q(n,i){if(n&1&&(s(0,"mat-option",18),c(1),r()),n&2){let e=i.$implicit;a("value",e),l(),E(" ",e.label," ")}}function Y(n,i){if(n&1&&(s(0,"mat-optgroup",17),u(1,Q,2,2,"mat-option",8),r()),n&2){let e=i.$implicit;a("label",e.module),l(),a("ngForOf",e.items)}}function Z(n,i){if(n&1){let e=f();b(0),s(1,"mat-select",15),M("valueChange",function(o){d(e);let g=m();return w(g.selectedPermission,o)||(g.selectedPermission=o),p(o)}),_("selectionChange",function(){d(e);let o=m();return p(o.loadConditions())}),u(2,Y,2,2,"mat-optgroup",16),r(),x()}if(n&2){let e=m();l(),y("value",e.selectedPermission),l(),a("ngForOf",e.permissionGroups)}}function q(n,i){n&1&&(s(0,"div",19),P(1,"div",20),c(2," Loading permissions\u2026 "),r())}function J(n,i){if(n&1&&(s(0,"mat-option",18),c(1),r()),n&2){let e=i.$implicit;a("value",e),l(),E(" ",e.name," ")}}function K(n,i){if(n&1){let e=f();s(0,"button",21),_("click",function(){d(e);let o=m();return p(o.enableEdit())}),c(1," Enable Editing "),r()}}function X(n,i){if(n&1){let e=f();b(0),s(1,"button",22),_("click",function(){d(e);let o=m();return p(o.cancelEdit())}),c(2,"Cancel"),r(),s(3,"button",21),_("click",function(){d(e);let o=m();return p(o.addCondition())}),c(4,"Add Condition"),r(),x()}}function ee(n,i){n&1&&(s(0,"div",23),P(1,"div",24)(2,"div",25)(3,"div",26),s(4,"div",27),c(5," Evaluating permission conditions\u2026 "),r()())}function te(n,i){n&1&&(s(0,"div",27),c(1," No conditions defined for this role "),r())}function ie(n,i){if(n&1){let e=f();s(0,"button",22),_("click",function(){d(e);let o=m().$implicit,g=m(2);return p(g.deleteCondition(o))}),c(1," Remove "),r()}}function ne(n,i){if(n&1&&(s(0,"li",29)(1,"span"),c(2),r(),u(3,ie,2,0,"button",30),r()),n&2){let e=i.$implicit,t=m(2);l(2),O("",e.param," == ",e.value,""),l(),a("ngIf",t.editMode)}}function oe(n,i){if(n&1&&(s(0,"ul",23),u(1,ne,4,3,"li",28),r()),n&2){let e=m();l(),a("ngForOf",e.conditions)}}var z=class n{svc=C(h);dialog=C(j);roles=[];permissions=[];permissionGroups=[];selectedPermission;selectedRole;conditions=[];editMode=!1;ROLE_ORDER=["SUPERUSER","ADMIN","MANAGER","SUPERVISOR","EMPLOYEE"];loadingPermissions=!0;loadingRoles=!0;loadingConditions=!1;ngOnInit(){this.loadRoles(),this.loadPermissions()}loadRoles(){this.loadingRoles=!0,this.svc.listRoles().subscribe(i=>{this.roles=[...i].sort((e,t)=>this.ROLE_ORDER.indexOf(e.name)-this.ROLE_ORDER.indexOf(t.name)),this.loadingRoles=!1})}loadPermissions(){this.loadingPermissions=!0,this.svc.listPermissions().subscribe(i=>{let e=i.map(t=>({id:t.id,code:t.code,module:this.extractModule(t.code),label:this.humanize(t.code)}));e.sort((t,o)=>t.module===o.module?t.label.localeCompare(o.label):t.module.localeCompare(o.module)),this.permissionGroups=this.buildGroups(e),this.loadingPermissions=!1})}loadConditions(){!this.selectedPermission||!this.selectedRole||(this.loadingConditions=!0,this.conditions=[],this.svc.listConditions(this.selectedPermission.id,this.selectedRole.name).subscribe(i=>{this.conditions=i,this.loadingConditions=!1}))}enableEdit(){this.editMode=!0}cancelEdit(){this.editMode=!1,this.loadConditions()}addCondition(){let i=prompt("Request parameter");if(!i)return;let e=prompt("Expected value");e!==null&&this.svc.addCondition(this.selectedPermission.id,{role:this.selectedRole.name,param:i,operator:"EQ",value:e}).subscribe(()=>this.loadConditions())}deleteCondition(i){let e=prompt("Reason for removal");e&&this.svc.softDeleteCondition(i.id,e).subscribe(()=>this.loadConditions())}buildGroups(i){let e=new Map;for(let t of i)e.has(t.module)||e.set(t.module,[]),e.get(t.module).push(t);return[...e.entries()].sort(([t],[o])=>t.localeCompare(o)).map(([t,o])=>({module:t,items:o}))}extractModule(i){let e=i.match(/API_[A-Z]+_API_([^_]+)/);return e?e[1]:"OTHER"}humanize(i){return i.replace(/^API_[A-Z]+_API_/,"").replace(/_/g," ").toLowerCase().replace(/\b\w/g,e=>e.toUpperCase())}static \u0275fac=function(e){return new(e||n)};static \u0275cmp=R({type:n,selectors:[["app-acl-permission-conditions"]],decls:21,vars:11,consts:[["permLoading",""],[1,"conditions-surface","space-y-4"],[1,"conditions-header"],[1,"section-title"],[1,"section-subtitle"],[1,"conditions-selectors"],[4,"ngIf","ngIfElse"],["placeholder","Role",1,"role-select",3,"valueChange","selectionChange","value"],[3,"value",4,"ngFor","ngForOf"],[1,"flex","gap-2"],["mat-flat-button","",3,"click",4,"ngIf"],[4,"ngIf"],[1,"surface"],["class","space-y-2",4,"ngIf"],["class","loading-hint",4,"ngIf"],["placeholder","Permission",1,"permission-select",3,"valueChange","selectionChange","value"],[3,"label",4,"ngFor","ngForOf"],[3,"label"],[3,"value"],[1,"progress-block"],[1,"progress-inline"],["mat-flat-button","",3,"click"],["mat-stroked-button","",3,"click"],[1,"space-y-2"],[1,"skeleton","w-60"],[1,"skeleton","w-40"],[1,"skeleton","w-80"],[1,"loading-hint"],["class","condition-row",4,"ngFor","ngForOf"],[1,"condition-row"],["mat-stroked-button","",3,"click",4,"ngIf"]],template:function(e,t){if(e&1){let o=f();s(0,"div",1)(1,"div",2)(2,"h2",3),c(3,"Permission Conditions"),r(),s(4,"p",4),c(5," Conditions are evaluated using OR semantics per role "),r()(),s(6,"div",5),u(7,Z,3,2,"ng-container",6)(8,q,3,0,"ng-template",null,0,V),s(10,"mat-select",7),M("valueChange",function(v){return d(o),w(t.selectedRole,v)||(t.selectedRole=v),p(v)}),_("selectionChange",function(){return d(o),p(t.loadConditions())}),u(11,J,2,2,"mat-option",8),r()(),s(12,"div",9),u(13,K,2,0,"button",10)(14,X,5,0,"ng-container",11),r(),s(15,"div",12)(16,"h3",3),c(17," Allow access if ANY of the following are true "),r(),u(18,ee,6,0,"div",13)(19,te,2,0,"div",14)(20,oe,2,1,"ul",13),r()()}if(e&2){let o=S(9);l(7),a("ngIf",!t.loadingPermissions)("ngIfElse",o),l(3),y("value",t.selectedRole),l(),a("ngForOf",t.roles),l(2),a("ngIf",!t.editMode),l(),a("ngIf",t.editMode),l(),I("loading-surface",t.loadingConditions),l(3),a("ngIf",t.loadingConditions),l(),a("ngIf",!t.loadingConditions&&!t.conditions.length),l(),a("ngIf",!t.loadingConditions&&t.conditions.length)}},dependencies:[F,T,k,W,G,B,U,$,L],styles:[".conditions-surface[_ngcontent-%COMP%]{background:var(--surface);border-radius:10px;padding:16px;box-shadow:var(--surface-shadow)}.conditions-header[_ngcontent-%COMP%]{margin-bottom:8px}.conditions-selectors[_ngcontent-%COMP%]{display:flex;gap:16px}.permission-select[_ngcontent-%COMP%], .role-select[_ngcontent-%COMP%]{min-width:280px}.condition-row[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;border:1px solid var(--border);border-radius:6px;background:var(--surface-hover);font-family:ui-monospace,monospace;font-size:.85rem}"],changeDetection:0})};export{z as AclPermissionConditionsComponent};
