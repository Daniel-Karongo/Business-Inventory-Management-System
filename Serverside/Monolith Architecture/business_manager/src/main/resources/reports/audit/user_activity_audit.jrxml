<?xml version="1.0" encoding="UTF-8"?>
<jasperReport
        xmlns="http://jasperreports.sourceforge.net/jasperreports"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports
        http://jasperreports.sourceforge.net/xsd/jasperreport.xsd"
        name="user_activity_audit"
        pageWidth="842"
        pageHeight="595"
        orientation="Landscape"
        columnWidth="802"
        leftMargin="20"
        rightMargin="20"
        topMargin="20"
        bottomMargin="20">

    <!-- ================= PARAMETERS ================= -->
    <parameter name="FROM_DATE" class="java.sql.Date"/>
    <parameter name="TO_DATE" class="java.sql.Date"/>

    <!-- ================= QUERY ================= -->
    <queryString>
        <![CDATA[
        SELECT
            pa.timestamp        AS activity_time,
            pa.performed_by     AS performed_by,
            'PRODUCT'           AS module,
            'Product'           AS entity,
            pa.product_name     AS entity_name,
            pa.action           AS action,
            pa.field_changed    AS field_changed,
            pa.old_value        AS old_value,
            pa.new_value        AS new_value,
            pa.reason           AS reason
        FROM product_audits pa
        WHERE DATE(pa.timestamp) BETWEEN $P{FROM_DATE} AND $P{TO_DATE}

        UNION ALL

        SELECT
            sa.timestamp        AS activity_time,
            sa.performed_by     AS performed_by,
            'SUPPLIER'          AS module,
            'Supplier'          AS entity,
            sa.supplier_name    AS entity_name,
            sa.action           AS action,
            sa.field_changed    AS field_changed,
            sa.old_value        AS old_value,
            sa.new_value        AS new_value,
            sa.reason           AS reason
        FROM supplier_audits sa
        WHERE DATE(sa.timestamp) BETWEEN $P{FROM_DATE} AND $P{TO_DATE}

        ORDER BY activity_time DESC
        ]]>
    </queryString>

    <!-- ================= FIELDS ================= -->
    <field name="activity_time" class="java.sql.Timestamp"/>
    <field name="performed_by" class="java.lang.String"/>
    <field name="module" class="java.lang.String"/>
    <field name="entity" class="java.lang.String"/>
    <field name="entity_name" class="java.lang.String"/>
    <field name="action" class="java.lang.String"/>
    <field name="field_changed" class="java.lang.String"/>
    <field name="old_value" class="java.lang.String"/>
    <field name="new_value" class="java.lang.String"/>
    <field name="reason" class="java.lang.String"/>

    <!-- ================= COLUMN HEADER ================= -->
    <columnHeader>
        <band height="30">
            <staticText><reportElement x="0" y="0" width="110" height="30"/><text><![CDATA[Time]]></text></staticText>
            <staticText><reportElement x="110" y="0" width="100" height="30"/><text><![CDATA[User]]></text></staticText>
            <staticText><reportElement x="210" y="0" width="80" height="30"/><text><![CDATA[Module]]></text></staticText>
            <staticText><reportElement x="290" y="0" width="100" height="30"/><text><![CDATA[Entity]]></text></staticText>
            <staticText><reportElement x="390" y="0" width="140" height="30"/><text><![CDATA[Name]]></text></staticText>
            <staticText><reportElement x="530" y="0" width="80" height="30"/><text><![CDATA[Action]]></text></staticText>
            <staticText><reportElement x="610" y="0" width="110" height="30"/><text><![CDATA[Field]]></text></staticText>
            <staticText><reportElement x="720" y="0" width="82" height="30"/><text><![CDATA[Old -> New]]></text></staticText>
        </band>
    </columnHeader>

    <!-- ================= DETAIL ================= -->
    <detail>
        <band height="25">
            <textField><reportElement x="0" y="0" width="110" height="25"/><textFieldExpression><![CDATA[$F{activity_time}]]></textFieldExpression></textField>
            <textField><reportElement x="110" y="0" width="100" height="25"/><textFieldExpression><![CDATA[$F{performed_by}]]></textFieldExpression></textField>
            <textField><reportElement x="210" y="0" width="80" height="25"/><textFieldExpression><![CDATA[$F{module}]]></textFieldExpression></textField>
            <textField><reportElement x="290" y="0" width="100" height="25"/><textFieldExpression><![CDATA[$F{entity}]]></textFieldExpression></textField>
            <textField><reportElement x="390" y="0" width="140" height="25"/><textFieldExpression><![CDATA[$F{entity_name}]]></textFieldExpression></textField>
            <textField><reportElement x="530" y="0" width="80" height="25"/><textFieldExpression><![CDATA[$F{action}]]></textFieldExpression></textField>
            <textField><reportElement x="610" y="0" width="110" height="25"/><textFieldExpression><![CDATA[$F{field_changed}]]></textFieldExpression></textField>
            <textField>
                <reportElement x="720" y="0" width="82" height="25"/>
                <textFieldExpression><![CDATA[
                    $F{old_value} + " -> " + $F{new_value}
                ]]></textFieldExpression>
            </textField>
        </band>
    </detail>

</jasperReport>