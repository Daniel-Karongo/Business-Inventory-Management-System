<?xml version="1.0" encoding="UTF-8"?>
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports"
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports
              http://jasperreports.sourceforge.net/xsd/jasperreport.xsd"
              name="customer_activity_timeline_single"
              pageWidth="595"
              pageHeight="842"
              columnWidth="555"
              leftMargin="20"
              rightMargin="20"
              topMargin="30"
              bottomMargin="30">

    <!-- PARAMETERS -->
    <parameter name="CUSTOMER_ID" class="java.lang.String"/>

    <!-- QUERY -->
    <queryString>
        <![CDATA[
            SELECT
                'SALE'          AS activity_type,
                s.id            AS reference_id,
                s.created_at    AS activity_date,
                s.status        AS status,
                s.total_amount  AS amount,
                NULL            AS method,
                NULL            AS note
            FROM sales s
            WHERE s.customer_id = UNHEX(REPLACE($P{CUSTOMER_ID}, '-', ''))

            UNION ALL

            SELECT
                'PAYMENT'       AS activity_type,
                p.id            AS reference_id,
                p.timestamp     AS activity_date,
                p.status        AS status,
                p.amount        AS amount,
                p.method        AS method,
                p.note          AS note
            FROM payments p
            JOIN sales s ON s.id = p.sale_id
            WHERE s.customer_id = UNHEX(REPLACE($P{CUSTOMER_ID}, '-', ''))
              AND p.status = 'SUCCESS'

            ORDER BY activity_date DESC
        ]]>
    </queryString>

    <!-- FIELDS -->
    <field name="activity_type" class="java.lang.String"/>
    <field name="reference_id" class="java.lang.String"/>
    <field name="activity_date" class="java.sql.Timestamp"/>
    <field name="status" class="java.lang.String"/>
    <field name="amount" class="java.math.BigDecimal"/>
    <field name="method" class="java.lang.String"/>
    <field name="note" class="java.lang.String"/>

    <!-- TITLE -->
    <title>
        <band height="40">
            <textField>
                <reportElement x="0" y="0" width="555" height="25"/>
                <textElement textAlignment="Center">
                    <font size="15" isBold="true"/>
                </textElement>
                <textFieldExpression><![CDATA["CUSTOMER ACTIVITY TIMELINE"]]></textFieldExpression>
            </textField>
        </band>
    </title>

    <!-- COLUMN HEADER -->
    <columnHeader>
        <band height="20">
            <staticText><reportElement x="0" y="0" width="80" height="20"/><text><![CDATA[Type]]></text></staticText>
            <staticText><reportElement x="80" y="0" width="100" height="20"/><text><![CDATA[Date]]></text></staticText>
            <staticText><reportElement x="180" y="0" width="110" height="20"/><text><![CDATA[Reference]]></text></staticText>
            <staticText><reportElement x="290" y="0" width="70" height="20"/><text><![CDATA[Status]]></text></staticText>
            <staticText><reportElement x="360" y="0" width="80" height="20"/><text><![CDATA[Amount]]></text></staticText>
            <staticText><reportElement x="440" y="0" width="115" height="20"/><text><![CDATA[Method / Note]]></text></staticText>
        </band>
    </columnHeader>

    <!-- DETAIL -->
    <detail>
        <band height="18">

            <textField>
                <reportElement x="0" y="0" width="80" height="18"/>
                <textFieldExpression><![CDATA[$F{activity_type}]]></textFieldExpression>
            </textField>

            <textField>
                <reportElement x="80" y="0" width="100" height="18"/>
                <textFieldExpression><![CDATA[$F{activity_date}]]></textFieldExpression>
            </textField>

            <textField>
                <reportElement x="180" y="0" width="110" height="18"/>
                <textFieldExpression><![CDATA[$F{reference_id}]]></textFieldExpression>
            </textField>

            <textField>
                <reportElement x="290" y="0" width="70" height="18"/>
                <textFieldExpression><![CDATA[$F{status}]]></textFieldExpression>
            </textField>

            <textField pattern="#,##0.00">
                <reportElement x="360" y="0" width="80" height="18"/>
                <textFieldExpression><![CDATA[$F{amount}]]></textFieldExpression>
            </textField>

            <textField>
                <reportElement x="440" y="0" width="115" height="18"/>
                <textFieldExpression><![CDATA[
                    $F{method} != null ? $F{method} : $F{note}
                ]]></textFieldExpression>
            </textField>

        </band>
    </detail>

</jasperReport>