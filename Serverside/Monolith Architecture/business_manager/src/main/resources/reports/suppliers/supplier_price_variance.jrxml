<?xml version="1.0" encoding="UTF-8"?>
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports"
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports
              http://jasperreports.sourceforge.net/xsd/jasperreport.xsd"
              name="supplier_price_variance"
              pageWidth="842"
              pageHeight="595"
              orientation="Landscape"
              columnWidth="782"
              leftMargin="30"
              rightMargin="30"
              topMargin="20"
              bottomMargin="20">

    <!-- ================= PARAMETERS ================= -->
    <parameter name="FROM_DATE" class="java.lang.String"/>
    <parameter name="TO_DATE" class="java.lang.String"/>

    <!-- ================= QUERY ================= -->
    <queryString>
        <![CDATA[
            SELECT
                p.name AS product_name,
                pv.sku AS variant_sku,
                s.name AS supplier_name,

                st.unit_cost AS supplier_unit_cost,

                AVG(st.unit_cost) OVER (
                    PARTITION BY st.product_variant_id
                ) AS avg_unit_cost_all_suppliers,

                st.unit_cost
                  - AVG(st.unit_cost) OVER (
                        PARTITION BY st.product_variant_id
                    ) AS price_variance,

                st.timestamp AS receipt_date

            FROM stock_transactions st
            JOIN suppliers s ON s.id = st.supplier_id
            JOIN products p ON p.id = st.product_id
            JOIN product_variants pv ON pv.id = st.product_variant_id

            WHERE st.type = 'RECEIPT'
              AND st.timestamp >= $P{FROM_DATE}
              AND st.timestamp <  DATE_ADD($P{TO_DATE}, INTERVAL 1 DAY)

            ORDER BY p.name ASC, price_variance DESC
        ]]>
    </queryString>

    <!-- ================= FIELDS ================= -->
    <field name="product_name" class="java.lang.String"/>
    <field name="variant_sku" class="java.lang.String"/>
    <field name="supplier_name" class="java.lang.String"/>
    <field name="supplier_unit_cost" class="java.math.BigDecimal"/>
    <field name="avg_unit_cost_all_suppliers" class="java.math.BigDecimal"/>
    <field name="price_variance" class="java.math.BigDecimal"/>
    <field name="receipt_date" class="java.sql.Timestamp"/>

    <!-- ================= COLUMN HEADER ================= -->
    <columnHeader>
        <band height="30">
            <staticText>
                <reportElement x="0" y="0" width="150" height="30"/>
                <text><![CDATA[Product]]></text>
            </staticText>

            <staticText>
                <reportElement x="150" y="0" width="100" height="30"/>
                <text><![CDATA[SKU]]></text>
            </staticText>

            <staticText>
                <reportElement x="250" y="0" width="150" height="30"/>
                <text><![CDATA[Supplier]]></text>
            </staticText>

            <staticText>
                <reportElement x="400" y="0" width="80" height="30"/>
                <text><![CDATA[Unit Cost]]></text>
            </staticText>

            <staticText>
                <reportElement x="480" y="0" width="100" height="30"/>
                <text><![CDATA[Avg Cost]]></text>
            </staticText>

            <staticText>
                <reportElement x="580" y="0" width="100" height="30"/>
                <text><![CDATA[Variance]]></text>
            </staticText>

            <staticText>
                <reportElement x="680" y="0" width="100" height="30"/>
                <text><![CDATA[Date]]></text>
            </staticText>
        </band>
    </columnHeader>

    <!-- ================= DETAIL ================= -->
    <detail>
        <band height="25">
            <textField>
                <reportElement x="0" y="0" width="150" height="25"/>
                <textFieldExpression><![CDATA[$F{product_name}]]></textFieldExpression>
            </textField>

            <textField>
                <reportElement x="150" y="0" width="100" height="25"/>
                <textFieldExpression><![CDATA[$F{variant_sku}]]></textFieldExpression>
            </textField>

            <textField>
                <reportElement x="250" y="0" width="150" height="25"/>
                <textFieldExpression><![CDATA[$F{supplier_name}]]></textFieldExpression>
            </textField>

            <textField>
                <reportElement x="400" y="0" width="80" height="25"/>
                <textFieldExpression><![CDATA[$F{supplier_unit_cost}]]></textFieldExpression>
            </textField>

            <textField>
                <reportElement x="480" y="0" width="100" height="25"/>
                <textFieldExpression><![CDATA[$F{avg_unit_cost_all_suppliers}]]></textFieldExpression>
            </textField>

            <textField>
                <reportElement x="580" y="0" width="100" height="25"/>
                <textFieldExpression><![CDATA[$F{price_variance}]]></textFieldExpression>
            </textField>

            <textField>
                <reportElement x="680" y="0" width="100" height="25"/>
                <textFieldExpression><![CDATA[$F{receipt_date}]]></textFieldExpression>
            </textField>
        </band>
    </detail>

</jasperReport>
