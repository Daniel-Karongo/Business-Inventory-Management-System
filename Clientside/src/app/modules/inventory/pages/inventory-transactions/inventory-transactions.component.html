<div class="transactions-container">

  <!-- ================= HEADER ================= -->
  <div class="header-block">
    <h1>Stock Transactions</h1>

    <div class="variant-info">
      Variant:
      {{ productName + ' - ' + variantName || variantId }}
    </div>
  </div>

  <!-- ================= STATES ================= -->
  <div *ngIf="loading" class="state-block">
    Loading transactions…
  </div>

  <div *ngIf="!loading && transactions.length === 0" class="state-block">
    No transactions found
  </div>

  <!-- ================= FILTERS ================= -->
  <div class="filters">

    <mat-form-field appearance="fill">
      <mat-label>From</mat-label>
      <input matInput
             [matDatepicker]="fromPicker"
             (dateChange)="applyFilters()"
             [(ngModel)]="fromDate">
      <mat-datepicker-toggle matSuffix [for]="fromPicker"></mat-datepicker-toggle>
      <mat-datepicker #fromPicker></mat-datepicker>
    </mat-form-field>

    <mat-form-field appearance="fill">
      <mat-label>To</mat-label>
      <input matInput
             [matDatepicker]="toPicker"
             (dateChange)="applyFilters()"
             [(ngModel)]="toDate">
      <mat-datepicker-toggle matSuffix [for]="toPicker"></mat-datepicker-toggle>
      <mat-datepicker #toPicker></mat-datepicker>
    </mat-form-field>

    <mat-form-field appearance="fill">
      <mat-label>Type</mat-label>
      <mat-select multiple
                  [(ngModel)]="selectedTypes"
                  (selectionChange)="applyFilters()">
        <mat-option *ngFor="let t of transactionTypes" [value]="t">
          {{ t }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="fill">
      <mat-label>Direction</mat-label>
      <mat-select [(ngModel)]="direction"
                  (selectionChange)="applyFilters()">
        <mat-option value="ALL">All</mat-option>
        <mat-option value="IN">Inbound</mat-option>
        <mat-option value="OUT">Outbound</mat-option>
      </mat-select>
    </mat-form-field>

  </div>

  <!-- ================= TABLE ================= -->
  <div *ngIf="!loading && transactions.length > 0"
       class="table-wrapper">

    <div class="table-scroll">

      <table mat-table [dataSource]="filtered" class="transactions-table">

        <!-- DATE -->
        <ng-container matColumnDef="timestamp">
          <th mat-header-cell *matHeaderCellDef>Date</th>
          <td mat-cell *matCellDef="let t">
            {{ t.timestamp | date:'medium' }}
          </td>
        </ng-container>

        <!-- TYPE -->
        <ng-container matColumnDef="type">
          <th mat-header-cell *matHeaderCellDef>Type</th>
          <td mat-cell *matCellDef="let t" [ngClass]="typeClass(t)">
            <div class="type-block">
              <mat-icon matTooltip="{{ t.type }}">
                {{ iconFor(t) }}
              </mat-icon>
              <span>{{ t.type }}</span>
            </div>
          </td>
        </ng-container>

        <!-- QTY -->
        <ng-container matColumnDef="quantity">
          <th mat-header-cell *matHeaderCellDef>Δ Qty</th>
          <td mat-cell *matCellDef="let t" [ngClass]="typeClass(t)">
            {{ signedQty(t) }}
          </td>
        </ng-container>

        <!-- BRANCH -->
        <ng-container matColumnDef="branch">
          <th mat-header-cell *matHeaderCellDef>Branch</th>
          <td mat-cell *matCellDef="let t">
            {{ t.branchName || '—' }}
          </td>
        </ng-container>

        <!-- REFERENCE -->
        <ng-container matColumnDef="reference">
          <th mat-header-cell *matHeaderCellDef>Reference</th>
          <td mat-cell *matCellDef="let t">
            {{ t.reference || '—' }}
          </td>
        </ng-container>

        <!-- NOTE -->
        <ng-container matColumnDef="note">
          <th mat-header-cell *matHeaderCellDef>Note</th>
          <td mat-cell *matCellDef="let t">
            {{ t.note || '—' }}
          </td>
        </ng-container>

        <!-- USER -->
        <ng-container matColumnDef="performedBy">
          <th mat-header-cell *matHeaderCellDef>User</th>
          <td mat-cell *matCellDef="let t">
            {{ t.performedBy || 'system' }}
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>

      </table>

    </div>
  </div>

</div>