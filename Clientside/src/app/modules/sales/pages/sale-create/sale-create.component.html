<div class="flex flex-col gap-6">

  <!-- PAGE HEADER -->
  <div>
    <h2 class="text-xl font-semibold">New Sale</h2>
    <p class="text-sm text-[var(--text-secondary)]">
      Add items and confirm
    </p>
  </div>

  <!-- CUSTOMER -->
  <div class="surface-card" [formGroup]="customerGroup">

    <div class="section-title">
      Customer (Optional)
      <span class="section-sub">
        Leave blank for walk-in customers
      </span>
    </div>

    <div class="grid-3">
      <mat-form-field>
        <mat-label>Name</mat-label>
        <input matInput formControlName="name" />
      </mat-form-field>

      <mat-form-field>
        <mat-label>Phone</mat-label>
        <input matInput formControlName="phone" />
      </mat-form-field>

      <mat-form-field>
        <mat-label>Email</mat-label>
        <input matInput formControlName="email" />
      </mat-form-field>
    </div>
  </div>

  <!-- BARCODE -->
  <div class="flex items-center gap-3">

    <mat-form-field class="flex-1">
      <mat-label>Scan / Enter Barcode or SKU</mat-label>
      <input matInput
             #barcodeInput
             [formControl]="barcodeCtrl"
             (keydown.enter)="scanBarcode()" />
    </mat-form-field>

    <button mat-stroked-button
            matTooltip="Scan using camera"
            *ngIf="canUseCameraScan()"
            (click)="startCameraScan()">
      <mat-icon>qr_code_scanner</mat-icon>
    </button>

  </div>

  <!-- SALE LINES -->
  <div class="rows">

    <div class="row-card"
         *ngFor="let row of items.controls; let i = index">

      <!-- HEADER -->
      <div class="row-header">
        <span>Line {{ i + 1 }}</span>

        <div class="flex items-center gap-2">

          <button mat-icon-button
                  matTooltip="Allocate inventory batches"
                  *ngIf="stockMap[i]?.batchCount"
                  (click)="openBatchAllocation(i)">
            <mat-icon>layers</mat-icon>
          </button>

          <button mat-icon-button
                  matTooltip="Remove this line"
                  (click)="removeLine(i)">
            <mat-icon>delete</mat-icon>
          </button>

        </div>
      </div>

      <!-- FIRST GRID -->
      <div class="grid-3">

        <mat-form-field class="cursor-pointer"
                        (click)="openProductSelector(i)">
          <mat-label>Product</mat-label>
          <input matInput readonly
                 [value]="items.at(i).value.productName || ''" />
          <button matSuffix mat-icon-button
                  matTooltip="Change product"
                  tabindex="-1">
            <mat-icon>edit</mat-icon>
          </button>
        </mat-form-field>

        <mat-form-field>
          <mat-label>Variant</mat-label>
          <mat-select [formControl]="controlAt(i,'productVariantId')"
                      (selectionChange)="onVariantChange(i, $event.value)">
            <mat-option *ngFor="let v of (variantsMap[i] || [])"
                        [value]="v.id">
              {{ v.classification || 'STANDARD' }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field>
          <mat-label>Branch</mat-label>
          <mat-select [formControl]="controlAt(i,'branchId')">
            <mat-option *ngFor="let b of branches"
                        [value]="b.id">
              {{ b.name }}
            </mat-option>
          </mat-select>
        </mat-form-field>

      </div>

      <!-- SECOND GRID -->
      <div class="grid-3">

        <mat-form-field>
          <mat-label>Quantity</mat-label>
          <input matInput type="number"
                 min="1"
                 [formControl]="controlAt(i,'quantity')">
        </mat-form-field>

        <mat-form-field>
          <mat-label>Unit Price</mat-label>
          <input matInput type="number"
                 min="0"
                 [formControl]="controlAt(i,'unitPrice')">
        </mat-form-field>

        <div class="line-total">
          {{ lineTotal(i) | currency:'KES ' }}
        </div>

      </div>

      <!-- STOCK INFO -->
      <div class="stock-info" *ngIf="stockMap[i]">
        {{ stockMap[i]?.available }} available Â·
        {{ stockMap[i]?.batchCount || 0 }} batches
      </div>

      <!-- COST PREVIEW -->
      <div class="cost-preview"
           *ngIf="costPreviewMap[i]">
        Cost: {{ costPreviewMap[i] | currency:'KES ' }}
      </div>

    </div>

  </div>

  <!-- ADD LINE -->
  <button mat-stroked-button (click)="addLine()">
    <mat-icon>add</mat-icon>
    Add Line
  </button>

  <!-- FOOTER -->
  <div class="sale-footer">
    <div class="sale-total">
      Total: {{ grandTotal() | currency:'KES ' }}
    </div>

    <button mat-flat-button (click)="submit()">
      Create Sale
    </button>
  </div>

</div>