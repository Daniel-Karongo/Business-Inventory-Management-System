<div class="user-create-root" [formGroup]="form">

  <!-- ========================= HEADER ========================= -->
  <header class="wizard-header">
    <!-- <div class="left">
      <h2>Create User</h2>
      <div class="breadcrumb-sub">Users / Create</div>
    </div> -->

    <div class="right">
      <button mat-stroked-button class="cancel-button" (click)="router.navigate(['/users'])">
        Cancel
      </button>
      <button mat-flat-button class="save-button" color="primary" [disabled]="busy" (click)="submit()">
        <mat-icon *ngIf="busy">hourglass_top</mat-icon>
        Save
      </button>
    </div>
  </header>

  <div class="create-body">
    <!-- ====================== STEPPER FRAME ====================== -->
    <nav class="wizard-steps">
      <div *ngFor="let label of steps; let i = index" class="step" [class.active]="i === step"
        [class.completed]="i < step" (click)="goTo(i)">
        <div class="num">{{ i + 1 }}</div>
        <div class="label">
          <div class="title">{{ label }}</div>
          <div class="subtitle" *ngIf="i < step">Completed</div>
        </div>
      </div>
    </nav>

    <!-- ============================ BODY ============================ -->
    <main class="wizard-body">

      <!-- ============= STEP 0 — BASIC INFO ============= -->
      <section *ngIf="step === 0">
        <div class="grid">
          <mat-form-field appearance="fill">
            <mat-label>Username</mat-label>
            <input matInput formControlName="username" placeholder="e.g. j.smith" />
          </mat-form-field>

          <mat-form-field appearance="fill">
            <mat-label>ID Number</mat-label>
            <input matInput formControlName="idNumber" placeholder="Optional" />
          </mat-form-field>
        </div>

        <div class="nav">
          <button mat-stroked-button (click)="next()">Next</button>
        </div>
      </section>

      <!-- ============= STEP 1 — CONTACTS ============= -->
      <section *ngIf="step === 1">
        <mat-form-field appearance="fill" class="w-full">
          <mat-label>Email addresses (comma separated)</mat-label>
          <input matInput [value]="form.get('emailAddresses')?.value?.join(', ')" (change)="onEmailsChange($event)"
            placeholder="alice@example.com, bob@acme.test" />
        </mat-form-field>

        <mat-form-field appearance="fill" class="w-full">
          <mat-label>Phone numbers (comma separated)</mat-label>
          <input matInput [value]="form.get('phoneNumbers')?.value?.join(', ')" (change)="onPhonesChange($event)"
            placeholder="0712xxxxxxx, +254712xxxxxx" />
        </mat-form-field>

        <div class="nav">
          <button mat-stroked-button (click)="prev()">Previous</button>
          <button mat-stroked-button color="primary" (click)="next()">Next</button>
        </div>
      </section>

      <!-- ============= STEP 2 — ROLE + PASSWORDS ============= -->
      <section *ngIf="step === 2">
        <mat-form-field appearance="fill" class="w-full">
          <mat-label>Role</mat-label>
          <mat-select formControlName="role">
            <mat-option *ngFor="let r of assignableRoles" [value]="r">{{ r }}</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="fill" class="w-full">
          <mat-label>Password</mat-label>
          <input matInput [type]="hidePw ? 'password' : 'text'" formControlName="password" />
          <button mat-icon-button matSuffix (click)="hidePw = !hidePw" type="button">
            <mat-icon>{{ hidePw ? 'visibility' : 'visibility_off' }}</mat-icon>
          </button>
        </mat-form-field>

        <mat-form-field appearance="fill" class="w-full">
          <mat-label>Confirm Password</mat-label>
          <input matInput [type]="hideConfirmPw ? 'password' : 'text'" formControlName="confirmPassword" />
          <button mat-icon-button matSuffix (click)="hideConfirmPw = !hideConfirmPw" type="button">
            <mat-icon>{{ hideConfirmPw ? 'visibility' : 'visibility_off' }}</mat-icon>
          </button>

          <mat-error *ngIf="form.get('confirmPassword')?.hasError('pwMismatch')">
            Passwords do not match
          </mat-error>
        </mat-form-field>

        <div class="nav">
          <button mat-stroked-button (click)="prev()">Previous</button>
          <button mat-stroked-button color="primary" (click)="next()">Next</button>
        </div>
      </section>

      <!-- ============= STEP 3 — ASSIGNMENTS ============= -->
      <section *ngIf="step === 3">
        <div class="assignments">

          <div class="assignment-row" *ngFor="let g of assignments.controls; let i = index" [formGroup]="g">

            <mat-form-field appearance="fill" class="col">
              <mat-label>Branch</mat-label>
              <mat-select formControlName="branchId" (selectionChange)="g.get('departmentId')!.setValue('')">
                <mat-option *ngFor="let b of branches" [value]="b.id">{{ b.name }}</mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="fill" class="col">
              <mat-label>Department</mat-label>
              <mat-select formControlName="departmentId">
                <mat-option *ngFor="let d of departmentsForBranch(g.get('branchId')!.value)" [value]="d.id">
                  {{ d.name }}
                </mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="fill" class="col-fluid">
              <mat-label>Position</mat-label>
              <mat-select formControlName="position">
                <mat-option value="member">Member</mat-option>
                <mat-option value="head">Head</mat-option>
              </mat-select>
            </mat-form-field>

            <button mat-icon-button color="warn" (click)="removeAssignment(i)">
              <mat-icon>delete</mat-icon>
            </button>

          </div>

          <button mat-stroked-button (click)="addAssignment()">Add Assignment</button>

          <div class="muted">If none provided, system will apply MAIN → GENERAL by default.</div>
        </div>

        <div class="nav">
          <button mat-stroked-button (click)="prev()">Previous</button>
          <button mat-stroked-button color="primary" (click)="next()">Next</button>
        </div>
      </section>

      <!-- ============= STEP 4 — FILES ============= -->
      <section *ngIf="step === 4" [formArrayName]="'files'">
        <div class="files-section">

          <input id="fileInput" type="file" hidden multiple accept="image/*,application/pdf"
            (change)="onFilesPicked($event)" />

          <button mat-stroked-button (click)="openFilePicker()">Upload files</button>

          <div class="preview-grid">

            <div class="preview-card" *ngFor="let fg of filesArray.controls; let i = index" [formGroupName]="i">

              <!-- Thumbnail -->
              <div class="thumb" (click)="viewFile(i)">
                <img *ngIf="previews[i].src" [src]="previews[i].src" />
                <div *ngIf="previews[i].type === 'application/pdf'" class="pdf-placeholder">
                  <mat-icon>picture_as_pdf</mat-icon>
                  <span>{{ previews[i].name }}</span>
                </div>
              </div>

              <!-- Metadata -->
              <div class="meta">
                <div class="filename">{{ previews[i].name }}</div>

                <mat-form-field appearance="fill">
                  <mat-label>Description</mat-label>
                  <mat-select formControlName="type">
                    <mat-option *ngFor="let opt of descriptionOptions" [value]="opt">
                      {{ opt }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>

                <!-- ✅ NOW THIS ALWAYS WORKS -->
                <mat-form-field appearance="fill" *ngIf="fg.get('type')?.value === 'Other'">
                  <mat-label>Enter description</mat-label>
                  <input matInput formControlName="custom" />
                </mat-form-field>

                <div class="card-actions">
                  <button mat-button (click)="viewFile(i)">
                    <mat-icon>visibility</mat-icon> View
                  </button>

                  <button mat-icon-button color="warn" (click)="removeFile(i)">
                    <mat-icon>close</mat-icon>
                  </button>
                </div>
              </div>

            </div>
          </div>
        </div>

        <div class="nav">
          <button mat-stroked-button (click)="prev()">Previous</button>
          <button mat-stroked-button color="primary" (click)="next()">Next</button>
        </div>
      </section>

      <!-- ============= STEP 5 — REVIEW ============= -->
      <section *ngIf="step === 5">

        <div class="review-card">

          <h3 class="summary-title">Summary</h3>

          <div class="summary-grid">

            <div class="col">
              <dt>Username</dt>
              <dd>{{ form.value.username }}</dd>

              <dt>ID Number</dt>
              <dd>{{ form.value.idNumber || '—' }}</dd>

              <dt>Emails</dt>
              <dd>{{ form.value.emailAddresses?.join(', ') || '—' }}</dd>
            </div>

            <div class="col">
              <dt>Phones</dt>
              <dd>{{ form.value.phoneNumbers?.join(', ') || '—' }}</dd>

              <dt>Role</dt>
              <dd>{{ form.value.role }}</dd>

              <dt>Files</dt>
              <dd>
                <ul *ngIf="filesArray.length; else noFiles">
                  <li *ngFor="let fg of filesArray.controls">
                    {{ fg.value.file?.name }} —
                    {{
                    fg.value.type === 'Other'
                    ? (fg.value.custom || 'Other')
                    : fg.value.type
                    }}
                  </li>
                </ul>

                <ng-template #noFiles>
                  <span class="muted">No files uploaded</span>
                </ng-template>
              </dd>
            </div>

          </div>

          <dt>Assignments</dt>
          <dd>
            <ul>
              <li *ngFor="let a of assignments.value">
                {{ getBranchName(a.branchId) }} →
                {{ getDeptName(a.departmentId) }}
                ({{ a.position }})
              </li>
            </ul>
          </dd>

        </div>

        <div class="nav">
          <button mat-stroked-button (click)="prev()">Previous</button>
          <button mat-flat-button color="primary" (click)="submit()">Create User</button>
        </div>
      </section>

    </main>
  </div>
</div>