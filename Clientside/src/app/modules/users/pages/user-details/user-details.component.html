<div class="user-details-root" *ngIf="!loading; else loadingTpl">

  <!-- HEADER -->
  <div class="page-header">
    <div>
      <h2>User Profile</h2>
      <div class="breadcrumb">Users / {{ user.username }}</div>
    </div>

    <button mat-stroked-button (click)="editUser()">
      <mat-icon>edit</mat-icon>
      Edit
    </button>
  </div>

  <div class="content-grid">

    <!-- LEFT -->
    <mat-card class="identity-card">
      <div class="avatar">{{ initials() }}</div>
      <div class="user-id" *ngIf="canViewUserId()">
        {{ user.id }}
      </div>
      <div class="username">{{ user.username }}</div>

      <div class="role-chip" [class.deleted]="user.deleted">
        {{ user.deleted ? 'DISABLED' : user.role }}
      </div>

      <div class="identity-actions" *ngIf="canManageUser()">

        <!-- SOFT DISABLE -->
        <button mat-stroked-button color="warn" *ngIf="!user.deleted" (click)="softDeleteUser()"
          matTooltip="Disable user (can be restored)">
          <mat-icon>block</mat-icon>
          Disable
        </button>

        <!-- RESTORE -->
        <button mat-stroked-button color="primary" *ngIf="user.deleted" (click)="restoreUser()"
          matTooltip="Restore disabled user">
          <mat-icon>restore</mat-icon>
          Restore
        </button>

        <!-- HARD DELETE -->
        <button mat-stroked-button class="danger" *ngIf="user.deleted && role === 'SUPERUSER'"
          (click)="hardDeleteUser()" matTooltip="Permanently delete user">
          <mat-icon>delete_forever</mat-icon>
          Delete permanently
        </button>
      </div>
    </mat-card>

    <!-- RIGHT -->
    <div class="details-column">

      <mat-tab-group class="user-tabs" dynamicHeight>

        <!-- PROFILE -->
        <mat-tab label="Profile">
          <mat-card class="info-card">
            <h3>Profile</h3>

            <div class="info-grid">
              <div>
                <label>ID Number</label>
                <div>{{ user.idNumber || '—' }}</div>
              </div>

              <div>
                <label>Role</label>
                <div>{{ user.role }}</div>
              </div>

              <div>
                <label>Emails</label>
                <div *ngFor="let e of user.emailAddresses">{{ e }}</div>
              </div>

              <div>
                <label>Phones</label>
                <div *ngFor="let p of user.phoneNumbers">{{ p }}</div>
              </div>

              <div>
                <label>Status</label>
                <div>{{ status() }}</div>
              </div>

              <div class="col-span-2">
                <label>Branches & Departments</label>

                <div class="branch-block" *ngFor="let b of user.branchHierarchy">
                  <div class="branch-name">{{ b.branchName }}</div>

                  <ul class="department-list">
                    <li *ngFor="let d of b.departments">
                      <span class="dept-name">{{ d.departmentName }}</span>
                      <span class="dept-role">{{ d.position }}</span>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </mat-card>
        </mat-tab>

        <!-- IMAGES -->
        <mat-tab *ngIf="canViewImages()">
          <ng-template mat-tab-label>
            Documents <span class="badge">{{ imageCount }}</span>
          </ng-template>
          <app-entity-image-manager [entityId]="user.id!" [adapter]="imageAdapter"
            [allowHardDelete]="role === 'SUPERUSER'" />
        </mat-tab>

        <!-- AUDITS -->
        <mat-tab *ngIf="canViewAudits()">
          <ng-template mat-tab-label>
            Audits <span class="badge">{{ auditCount }}</span>
          </ng-template>
          <app-user-audit-timeline [userId]="user.id!" />
        </mat-tab>

        <!-- ROLLCALLS -->
        <mat-tab *ngIf="canViewRollcalls()">
          <ng-template mat-tab-label>
            Rollcalls <span class="badge">{{ rollcallCount }}</span>
          </ng-template>
          <app-user-rollcalls [userId]="user.id!" />
        </mat-tab>

      </mat-tab-group>
    </div>
  </div>
</div>

<ng-template #loadingTpl>
  <div class="loading">Loading user…</div>
</ng-template>