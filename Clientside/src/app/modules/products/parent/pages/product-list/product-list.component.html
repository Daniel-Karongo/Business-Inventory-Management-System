<app-page-shell>

  <!-- ================= HEADER ================= -->
  <div page-header>

    <div class="product-header">

      <div class="header-left">

        <button mat-icon-button matTooltip="Grid View" [class.active]="viewMode === 'grid'" (click)="setView('grid')">
          <mat-icon>grid_view</mat-icon>
        </button>

        <button mat-icon-button matTooltip="Table View" [class.active]="viewMode === 'table'"
          (click)="setView('table')">
          <mat-icon>table_rows</mat-icon>
        </button>

        <button *ngIf="!isMobile" mat-icon-button matTooltip="Toggle Density" (click)="toggleDensity()">
          <mat-icon>format_line_spacing</mat-icon>
        </button>

      </div>

      <div class="header-right">
        <button mat-stroked-button (click)="openBulkImport()">
          Bulk Import
        </button>

        <button mat-flat-button routerLink="/products/create">
          + Create Product
        </button>
      </div>

    </div>

  </div>

  <!-- ================= TOOLBAR ================= -->
  <div page-toolbar class="product-toolbar">
    <div class="search">
      <mat-form-field appearance="fill" class="search-field">
        <mat-label>Search name, category or SKU</mat-label>
        <input matInput (input)="onSearchChange($any($event.target).value)">
        <button matSuffix mat-icon-button (click)="onSearchChange('')">
          <mat-icon>close</mat-icon>
        </button>
      </mat-form-field>
    </div>
    <div class="filters">
      <mat-form-field appearance="fill">
        <mat-label>Category</mat-label>
        <mat-select (selectionChange)="onCategoryChange($event.value)">
          <mat-option [value]="null">All</mat-option>
          <mat-option *ngFor="let c of categories" [value]="c.id">
            {{ c.name }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="fill">
        <mat-label>Supplier</mat-label>
        <mat-select (selectionChange)="onSupplierChange($event.value)">
          <mat-option [value]="null">All</mat-option>
          <mat-option *ngFor="let s of suppliers" [value]="s.id">
            {{ s.name }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="fill">
        <mat-label>Min Suppliers</mat-label>
        <input matInput type="number" (input)="onMinSuppliersChange($any($event.target).value)">
      </mat-form-field>

      <mat-form-field appearance="fill">
        <mat-label>Max Suppliers</mat-label>
        <input matInput type="number" (input)="onMaxSuppliersChange($any($event.target).value)">
      </mat-form-field>

      <!-- STATUS FILTER -->
      <mat-form-field *ngIf="canManageDeleted" appearance="fill">
        <mat-label>Status</mat-label>
        <mat-select (selectionChange)="onStatusChange($event.value)">
          <mat-option value="all">All</mat-option>
          <mat-option value="active">Active</mat-option>
          <mat-option value="deleted">Deleted</mat-option>
        </mat-select>
      </mat-form-field>

      <!-- SHOW DELETED -->
      <mat-checkbox *ngIf="canManageDeleted" (change)="onToggleShowDeleted($event.checked)">
        Show deleted
      </mat-checkbox>
    </div>
  </div>

  <!-- ================= CONTENT ================= -->
  <div page-content>

    <div *ngIf="selectedIds.size > 0" class="bulk-bar">

      <span class="bulk-count">
        {{ selectedIds.size }} selected
      </span>

      <button *ngIf="bulkState === 'active'" mat-stroked-button color="warn" (click)="bulkSoftDelete()">
        Soft Delete
      </button>

      <button *ngIf="bulkState === 'deleted'" mat-stroked-button color="primary" (click)="bulkRestore()">
        Restore
      </button>

      <button *ngIf="bulkState === 'deleted'" mat-flat-button color="warn" (click)="bulkHardDelete()">
        Hard Delete
      </button>

      <span *ngIf="bulkState === 'mixed'" class="bulk-error">
        Mixed selection — cannot perform bulk action
      </span>

      <button mat-button class="cancel-selection" (click)="clearSelection()">
        Cancel Selection
      </button>

    </div>

    <!-- GRID VIEW -->
    <div *ngIf="!loading && viewMode === 'grid'" class="product-grid" [class.compact]="density === 'compact'"
      [class.comfortable]="density === 'comfortable'">

      <div *ngFor="let p of products" class="product-card" [class.compact]="density === 'compact'"
        [class.comfortable]="density === 'comfortable'" [class.deleted]="p.deleted"
        [class.selected]="selectedIds.has(p.id)" (click)="toggleRowSelection(p)">

        <div class="card-thumb" (click)="openImageViewer(p); $event.stopPropagation()">
          <img *ngIf="p.thumbnail" [src]="p.thumbnail" loading="lazy" class="product-thumb"
            (error)="onThumbnailError(p)" />
          <div *ngIf="!p.thumbnail" class="thumb-placeholder">
            <mat-icon>inventory_2</mat-icon>
          </div>
        </div>

        <div class="card-title">
          {{ p.name }}
        </div>

        <div class="card-sub">
          {{ p.categoryName || '—' }}
        </div>

        <div class="card-sub text-xs">
          SKU: {{ p.sku || '—' }}
        </div>

        <div class="card-meta">
          Variants: {{ p.variants.length || 0 }}
          · Suppliers: {{ p.suppliers.length || 0 }}
        </div>

        <div class="card-actions">

          <button mat-icon-button matTooltip="Create Sale" (click)="createSale(p)">
            <mat-icon>point_of_sale</mat-icon>
          </button>

          <button mat-icon-button matTooltip="View" [routerLink]="['/products', p.id]">
            <mat-icon>visibility</mat-icon>
          </button>

          <button mat-icon-button matTooltip="Edit" [routerLink]="['/products', p.id, 'edit']">
            <mat-icon>edit</mat-icon>
          </button>

        </div>

      </div>

    </div>

    <!-- TABLE VIEW -->
    <div *ngIf="!loading && viewMode === 'table'" class="table-wrapper" [class.compact]="density === 'compact'">

      <div class="overflow-x-auto" *ngIf="!isMobile">

        <table mat-table [dataSource]="products">

          <!-- SELECT -->
          <ng-container matColumnDef="select">
            <th mat-header-cell *matHeaderCellDef>
              <mat-checkbox [checked]="isAllSelected()" [indeterminate]="selectedIds.size > 0 && !isAllSelected()"
                (change)="masterToggle()">
              </mat-checkbox>
            </th>

            <td mat-cell *matCellDef="let row">
              <mat-checkbox (click)="$event.stopPropagation()" (change)="toggleRowSelection(row)"
                [checked]="selectedIds.has(row.id)">
              </mat-checkbox>
            </td>
          </ng-container>

          <!-- NAME -->
          <ng-container matColumnDef="name">
            <th mat-header-cell *matHeaderCellDef (click)="sortBy('name')" class="sortable" matTooltip="Sort by name"
              matTooltipPosition="above">
              <span class="sortable-content">
                Name
                <mat-icon class="sort-icon">
                  {{ getSortIcon('name') }}
                </mat-icon>
              </span>
            </th>

            <td mat-cell *matCellDef="let row">
              <a [routerLink]="['/products', row.id]" [state]="{ deleted: row.deleted }"
                class="text-blue-600 hover:underline">
                {{ row.name }}
              </a>
            </td>
          </ng-container>

          <!-- CATEGORY -->
          <ng-container matColumnDef="category">
            <th mat-header-cell *matHeaderCellDef (click)="sortBy('category.name')" class="sortable"
              matTooltip="Sort by category" matTooltipPosition="above">

              <span class="sortable-content">
                Category
                <mat-icon class="sort-icon">
                  {{ getSortIcon('category.name') }}
                </mat-icon>
              </span>

            </th>

            <td mat-cell *matCellDef="let row">
              {{ row.categoryName || '—' }}
            </td>
          </ng-container>

          <!-- VARIANTS -->
          <ng-container matColumnDef="variants">
            <th mat-header-cell *matHeaderCellDef (click)="sortBy('variantCount')" class="sortable">

              <span class="sortable-content">
                Variants
                <mat-icon class="sort-icon">
                  {{ getSortIcon('variantCount') }}
                </mat-icon>
              </span>
            </th>

            <td mat-cell *matCellDef="let row">
              {{ row.variants?.length || 0 }}
            </td>
          </ng-container>

          <!-- SKU -->
          <ng-container matColumnDef="sku">
            <th mat-header-cell *matHeaderCellDef (click)="sortBy('sku')" class="sortable" matTooltip="Sort by sku code"
              matTooltipPosition="above">
              <span class="sortable-content">
                SKU
                <mat-icon class="sort-icon">
                  {{ getSortIcon('sku') }}
                </mat-icon>
              </span>
            </th>

            <td mat-cell *matCellDef="let row">
              {{ row.sku || '—' }}
            </td>
          </ng-container>

          <!-- SUPPLIERS -->
          <ng-container matColumnDef="suppliers">
            <th mat-header-cell *matHeaderCellDef (click)="sortBy('supplierCount')" class="sortable">
              <span class="sortable-content">
                Suppliers
                <mat-icon class="sort-icon">
                  {{ getSortIcon('supplierCount') }}
                </mat-icon>
              </span>
            </th>

            <td mat-cell *matCellDef="let row">
              {{ row.suppliers?.length || 0 }}
            </td>
          </ng-container>

          <!-- STATUS -->
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef (click)="sortBy('deleted')" class="sortable"
              matTooltip="Sort by status" matTooltipPosition="above">
              <span class="sortable-content">
                Status
                <mat-icon class="sort-icon">
                  {{ getSortIcon('deleted') }}
                </mat-icon>
              </span>
            </th>

            <td mat-cell *matCellDef="let row">
              <span [ngClass]="{ 'text-green-400': !row.deleted, 'text-red-400': row.deleted }">
                {{ row.deleted ? 'Disabled' : 'Active' }}
              </span>
            </td>
          </ng-container>

          <!-- UPDATED -->
          <ng-container matColumnDef="updated">
            <th mat-header-cell *matHeaderCellDef (click)="sortBy('updatedAt')" class="sortable"
              matTooltip="Sort by date of last update" matTooltipPosition="above">
              <span class="sortable-content">
                Updated
                <mat-icon class="sort-icon">
                  {{ getSortIcon('updatedAt') }}
                </mat-icon>
              </span>
            </th>

            <td mat-cell *matCellDef="let row">
              {{ row.updatedAt | date:'medium' }}
            </td>
          </ng-container>

          <!-- ACTIONS -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef [attr.aria-label]="'Product actions'"> Actions</th>

            <td mat-cell *matCellDef="let row">
              <button mat-icon-button matTooltip="Create Sale" (click)="createSale(row); $event.stopPropagation()">
                <mat-icon>point_of_sale</mat-icon>
              </button>
              <button mat-icon-button matTooltip="View Product" [routerLink]="['/products', row.id]"
                [state]="{ deleted: row.deleted }">
                <mat-icon>visibility</mat-icon>
              </button>
              <button mat-icon-button matTooltip="Edit Product" [routerLink]="['/products', row.id, 'edit']"
                [state]="{ deleted: row.deleted }">
                <mat-icon>edit</mat-icon>
              </button>
            </td>
          </ng-container>

          <!-- ROWS -->
          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>

          <tr mat-row *matRowDef="let row; columns: displayedColumns" (click)="toggleRowSelection(row)"
            [ngClass]="{ 'row-selected': selectedIds.has(row.id) }" class="clickable-row">
          </tr>

        </table>

      </div>

      <!-- MOBILE STACKED -->
      <div *ngIf="isMobile" class="stacked-wrapper" [class.compact]="density === 'compact'"
        [class.comfortable]="density === 'comfortable'">

        <div *ngFor="let p of products; trackBy: trackById" class="stacked-row" [class.deleted]="p.deleted"
          [class.selected]="selectedIds.has(p.id)" (click)="toggleRowSelection(p)">

          <!-- TOP ROW -->
          <div class="stacked-top">

            <mat-checkbox (click)="$event.stopPropagation()" (change)="toggleRowSelection(p)"
              [checked]="selectedIds.has(p.id)">
            </mat-checkbox>

            <div class="stacked-title">
              {{ p.name }}
            </div>

          </div>

          <div class="stacked-sub">
            {{ p.categoryName || '—' }}
          </div>

          <div class="stacked-grid">

            <div>
              <div class="label">SKU</div>
              <div class="value">{{ p.sku }}</div>
            </div>

            <div>
              <div class="label">Variants</div>
              <div class="value">{{ p.variants.length || 0 }}</div>
            </div>

            <div>
              <div class="label">Suppliers</div>
              <div class="value">{{ p.suppliers.length || 0 }}</div>
            </div>

            <div>
              <div class="label">Status</div>
              <div class="value" [ngClass]="{ 'text-green-400': !p.deleted, 'text-red-400': p.deleted }">
                {{ p.deleted ? 'Disabled' : 'Active' }}
              </div>
            </div>

          </div>

          <div class="stacked-actions">

            <button mat-icon-button matTooltip="Create Sale" (click)="createSale(p); $event.stopPropagation()">
              <mat-icon>point_of_sale</mat-icon>
            </button>

            <button mat-icon-button matTooltip="View" (click)="$event.stopPropagation()"
              [routerLink]="['/products', p.id]">
              <mat-icon>visibility</mat-icon>
            </button>

            <button mat-icon-button matTooltip="Edit" (click)="$event.stopPropagation()"
              [routerLink]="['/products', p.id, 'edit']">
              <mat-icon>edit</mat-icon>
            </button>

          </div>

        </div>

      </div>


    </div>
    <div class="shared-paginator">
      <mat-paginator [disabled]="loading" [length]="totalServerElements" [pageSize]="currentUiPageSize"
        [pageSizeOptions]="[10,25,50,100]" showFirstLastButtons (page)="changePage($event)">
      </mat-paginator>
    </div>
  </div>

</app-page-shell>