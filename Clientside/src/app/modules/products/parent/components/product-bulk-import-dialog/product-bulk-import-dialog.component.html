<form [formGroup]="form" (keydown.enter)="$event.stopPropagation()">

  <app-bulk-import-shell [title]="config.title" [rowCount]="rowCount" [submitting]="submitting"
    [formInvalid]="form.invalid" [loading]="submitting || loading" [progress]="progress" (importCsv)="importCsv($event)"
    (importExcel)="importExcel($event)" (downloadCsv)="downloadCsvTemplate()" (downloadExcel)="downloadExcelTemplate()"
    (submit)="submit()" (cancel)="close()" (goToLine)="goToLine($event)" (goTop)="scrollToTop()"
    (goBottom)="scrollToBottom()" (prevError)="goToPreviousError()" (nextError)="goToNextError()"
    (clearAll)="clearRows()" (exportCsv)="exportCsvCurrentRows()" (exportExcel)="exportExcelCurrentRows()"
    (zipDropped)="importZip($event)" [supportsArchiveImport]="supportsArchiveImport">

    <div class="products-body">

      <div bulk-options class="bulk-options">

        <mat-checkbox formControlName="dryRun">
          Dry run (validate only)
        </mat-checkbox>

        <mat-checkbox [(ngModel)]="createMissingCategories" [ngModelOptions]="{ standalone: true }">
          Auto-create missing categories
        </mat-checkbox>

        <mat-checkbox [(ngModel)]="createMissingSuppliers" [ngModelOptions]="{ standalone: true }">
          Auto-create missing suppliers
        </mat-checkbox>

      </div>

      <div class="rows" formArrayName="rows">

        <div class="row-card" *ngFor="let r of rows.controls; let i = index; trackBy: trackByIndex" [formGroupName]="i">

          <div class="row-header">
            <span>Product {{ i + 1 }}</span>
            <button mat-icon-button color="warn" (click)="removeRow(i)">
              <mat-icon>delete</mat-icon>
            </button>
          </div>

          <div class="grid-2">
            <mat-form-field>
              <input matInput placeholder="Name" formControlName="name">
            </mat-form-field>

            <mat-form-field>
              <input matInput placeholder="Category" formControlName="categoryName">
            </mat-form-field>
          </div>

          <div class="grid-2">
            <mat-form-field>
              <input matInput placeholder="Suppliers" formControlName="supplierNames">
            </mat-form-field>

            <mat-form-field>
              <input matInput placeholder="Variants" formControlName="variants" (input)="uppercaseVariants(i)">
            </mat-form-field>
          </div>

          <mat-form-field>
            <input matInput type="number" placeholder="Minimum % Profit" formControlName="minimumPercentageProfit">
          </mat-form-field>

          <input type="file" multiple hidden #fileInput
            (change)="onRowFilesSelected(i, fileInput.files); fileInput.value = ''" />

          <button mat-stroked-button (click)="fileInput.click()">
            Upload Files
          </button>

          <app-bulk-file-assignment [files]="getRowFiles(i)" [rowIndex]="i" [rowVariants]="getRowVariants(i)"
            (remove)="onFileRemove($event)" (assign)="openAssignmentDialog($event)"
            (multiAssign)="openAssignmentDialog($event)" [multiSelectMode]="true">
          </app-bulk-file-assignment>

          <div class="row-error" *ngIf="r.value._error">
            {{ r.value._error }}
          </div>

        </div>
      </div>

      <div *ngIf="getUnassignedFiles().length" class="unassigned-section">

        <h3>Unassigned Files</h3>

        <app-bulk-file-assignment [files]="getUnassignedFiles()" [multiSelectMode]="true"
          (multiAssign)="openAssignmentDialog($event)" (remove)="onFileRemove($event)">
        </app-bulk-file-assignment>

      </div>

      <button mat-stroked-button (click)="addRow()">
        + Add Product
      </button>

      <div #bottomAnchor></div>

    </div>
  </app-bulk-import-shell>
</form>